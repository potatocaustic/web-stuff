<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RKL Draft Lottery Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f4;
            color: #333;
        }
        /* Header & Nav styles from other pages */
        header {
            background-color: #333;
            color: #fff;
            padding: 1rem;
            text-align: center;
        }
        header h1 {
            color: white !important;
            font-size: 2rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .header-logo {
            width: 40px;
            height: 40px;
            object-fit: cover;
        }
        nav {
            position: relative;
        }
        nav ul {
            display: flex;
            justify-content: center;
            list-style: none;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        nav ul li {
            margin: 0.5rem 1rem;
        }
        nav ul li a {
            color: #fff;
            text-decoration: none;
            font-size: 1.1rem;
            transition: color 0.3s ease;
        }
        .original-team-traded {
            opacity: 0.6;
            text-decoration: line-through;
        }
        .team-logo {
            width: 28px;
            height: 28px;
            object-fit: contain;
            flex-shrink: 0;
        }
        .move-up {
            color: #16a34a; /* green-600 */
            font-weight: 600;
        }
        .move-down {
            color: #dc2626; /* red-600 */
            font-weight: 600;
        }
        .no-move {
            color: #6b7280; /* gray-500 */
        }
        .top-pick-row {
            background-color: #fef9c3; /* yellow-100 */
        }
         /* Main simulation button style */
        .action-button {
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header>
      <h1>
        <img src="icons/RKL.webp" alt="RKL Logo" class="header-logo" onerror="this.style.display='none'">
        <span class="header-text">Real Karma League</span>
      </h1>
      <nav>
        <ul id="nav-menu">
          <li><a href="RKL-S7.html">S7 Home</a></li>
          <li><a href="standings.html">Standings & Rankings</a></li>
          <li><a href="draft-capital.html">Draft Capital</a></li>
        </ul>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-8">
        
        <div class="flex justify-center">
            <div class="bg-white rounded-lg shadow-lg mb-8 overflow-hidden w-full max-w-5xl">
                <div class="p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h2 id="table-title" class="text-2xl font-bold mb-1">Lottery Odds</h2>
                            <p id="table-description" class="text-gray-600">Odds for the 14 non-playoff teams to land a top 4 pick in the upcoming draft.</p>
                        </div>
                        <!-- Simulation/Reset Button Container -->
                        <div id="button-container" class="flex flex-col sm:flex-row justify-end items-center gap-2">
                            <!-- Buttons are injected here by JS -->
                        </div>
                    </div>
                </div>

                <!-- Lottery Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead id="lottery-table-head" class="text-xs text-gray-700 uppercase bg-gray-50">
                            <!-- Header content is generated by JS -->
                        </thead>
                        <tbody id="lottery-table-body">
                            <!-- Body content is generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="text-center py-6 mt-8">
        <p class="text-gray-500 text-sm">@caustic on Real</p>
    </footer>

<script>
// --- DATA AND CONFIGURATION ---
const SHEET_ID = '12EembQnztbdKx2-buv00--VDkEFSTuSXTRdOnTnRxq4';
const BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=`;

const lotteryOdds = [
    { seed: 1, chances: 140, pct1st: 14.0, pctTop4: 52.14 }, { seed: 2, chances: 140, pct1st: 14.0, pctTop4: 52.14 },
    { seed: 3, chances: 140, pct1st: 14.0, pctTop4: 52.14 }, { seed: 4, chances: 125, pct1st: 12.5, pctTop4: 48.08 },
    { seed: 5, chances: 105, pct1st: 10.5, pctTop4: 42.13 }, { seed: 6, chances: 90, pct1st: 9.0, pctTop4: 37.23 },
    { seed: 7, chances: 75, pct1st: 7.5, pctTop4: 31.96 }, { seed: 8, chances: 60, pct1st: 6.0, pctTop4: 26.30 },
    { seed: 9, chances: 45, pct1st: 4.5, pctTop4: 20.27 }, { seed: 10, chances: 30, pct1st: 3.0, pctTop4: 13.88 },
    { seed: 11, chances: 20, pct1st: 2.0, pctTop4: 9.41 }, { seed: 12, chances: 15, pct1st: 1.5, pctTop4: 7.12 },
    { seed: 13, chances: 10, pct1st: 1.0, pctTop4: 4.79 }, { seed: 14, chances: 5, pct1st: 0.5, pctTop4: 2.41 },
];
const DRAFT_SEASON = 8;

// --- STATE MANAGEMENT ---
let initialLotteryTeams = [];
let teamDataMap = {};
let pickOwnership = {};

// --- UTILITY FUNCTIONS ---
async function fetchSheetData(sheetName) {
    try {
        const response = await fetch(`${BASE_URL}${encodeURIComponent(sheetName)}`);
        if (!response.ok) throw new Error(`Network response not OK for ${sheetName}`);
        return parseCSV(await response.text());
    } catch (error) {
        console.error(`Error fetching ${sheetName}:`, error);
        return null;
    }
}

function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
    return lines.slice(1).map(line => {
        const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
        const row = {};
        if (values.length === headers.length) {
            headers.forEach((header, index) => {
                row[header] = values[index].replace(/"/g, '').trim();
            });
        }
        return row;
    }).filter(row => Object.keys(row).length > 0);
}

// --- RENDERING FUNCTIONS ---
function renderTableHeader(isSimulatedView = false) {
    const pickOrSeed = isSimulatedView ? 'Pick' : 'Seed';
    document.getElementById('lottery-table-head').innerHTML = `
        <tr>
            <th scope="col" class="px-4 md:px-6 py-3">${pickOrSeed}</th>
            <th scope="col" class="px-4 md:px-6 py-3">Team</th>
            <th scope="col" class="px-4 md:px-6 py-3 text-center hidden md:table-cell">Record</th>
            <th scope="col" class="px-4 md:px-6 py-3 text-center">#1 Pick Odds</th>
            <th scope="col" class="px-4 md:px-6 py-3 text-center hidden md:table-cell">Top 4 Odds</th>
        </tr>
    `;
}

function getTeamCellHtml(ownerTeam, originalTeam, ownerId, isTraded) {
    if (isTraded) {
        return `
            <div class="flex items-center gap-3">
                <img src="icons/${ownerId}.webp" alt="${ownerTeam.team_name}" class="team-logo" onerror="this.style.display='none'">
                <div class="flex items-center gap-2">
                    <span class="font-semibold text-gray-900">${ownerTeam.team_name}</span>
                    <span class="original-team-traded">${originalTeam.team_name}</span>
                </div>
            </div>
        `;
    } else {
        return `
            <div class="flex items-center gap-3">
                <img src="icons/${ownerId}.webp" alt="${ownerTeam.team_name}" class="team-logo" onerror="this.style.display='none'">
                <span class="font-semibold text-gray-900">${ownerTeam.team_name}</span>
            </div>
        `;
    }
}


function renderLotteryOddsTable() {
    renderTableHeader(false);
    const tableBody = document.getElementById('lottery-table-body');
    let html = '';

    initialLotteryTeams.forEach(team => {
        const ownerId = pickOwnership[team.team_id] || team.team_id;
        const ownerTeam = teamDataMap[ownerId];
        const isTraded = team.team_id !== ownerId;
        const teamCellHtml = getTeamCellHtml(ownerTeam, team, ownerId, isTraded);

        html += `
            <tr class="bg-white border-b hover:bg-gray-50">
                <td class="px-4 md:px-6 py-4 font-bold text-gray-900">${team.seed}</td>
                <td class="px-4 md:px-6 py-4">${teamCellHtml}</td>
                <td class="px-4 md:px-6 py-4 text-center font-medium hidden md:table-cell">${team.wins} - ${team.losses}</td>
                <td class="px-4 md:px-6 py-4 text-center">${team.pct1st.toFixed(2)}%</td>
                <td class="px-4 md:px-6 py-4 text-center hidden md:table-cell">${team.pctTop4.toFixed(2)}%</td>
            </tr>
        `;
    });
    tableBody.innerHTML = html;
}

function renderSimulatedResults(finalOrder) {
    renderTableHeader(true);
    const tableBody = document.getElementById('lottery-table-body');
    let html = '';

    finalOrder.forEach((originalTeam, index) => {
        const pickNumber = index + 1;
        const ownerId = pickOwnership[originalTeam.team_id] || originalTeam.team_id;
        const ownerTeam = teamDataMap[ownerId];
        const isTraded = originalTeam.team_id !== ownerId;
        const movement = originalTeam.seed - pickNumber;

        let movementHtml;
        if (movement > 0) {
            movementHtml = `<span class="move-up text-xs ml-2">▲ ${movement}</span>`;
        } else if (movement < 0) {
            movementHtml = `<span class="move-down text-xs ml-2">▼ ${Math.abs(movement)}</span>`;
        } else {
            movementHtml = ``; // No indicator for no move
        }
        
        const teamCellHtml = getTeamCellHtml(ownerTeam, originalTeam, ownerId, isTraded);

        html += `
            <tr class="bg-white border-b hover:bg-gray-50 fade-in ${pickNumber === 1 ? 'top-pick-row' : ''}" style="animation-delay: ${index * 50}ms;">
                <td class="px-4 md:px-6 py-4 font-bold text-gray-900">
                    <div class="flex items-center">
                        <span>${pickNumber}</span>
                        ${movementHtml}
                    </div>
                </td>
                <td class="px-4 md:px-6 py-4">${teamCellHtml}</td>
                <td class="px-4 md:px-6 py-4 text-center font-medium hidden md:table-cell">${originalTeam.wins} - ${originalTeam.losses}</td>
                <td class="px-4 md:px-6 py-4 text-center">${originalTeam.pct1st.toFixed(2)}%</td>
                <td class="px-4 md:px-6 py-4 text-center hidden md:table-cell">${originalTeam.pctTop4.toFixed(2)}%</td>
            </tr>
        `;
    });
    tableBody.innerHTML = html;
}


// --- SIMULATION LOGIC ---
function runSimulation() {
    const combinations = [];
    initialLotteryTeams.forEach(team => {
        for (let i = 0; i < team.chances; i++) {
            combinations.push(team.seed);
        }
    });

    const top4WinningSeeds = [];
    while (top4WinningSeeds.length < 4) {
        const randomIndex = Math.floor(Math.random() * combinations.length);
        const winningSeed = combinations[randomIndex];
        if (!top4WinningSeeds.includes(winningSeed)) {
            top4WinningSeeds.push(winningSeed);
        }
    }
    
    const lotteryWinners = top4WinningSeeds.map(seed => initialLotteryTeams.find(t => t.seed === seed));
    const remainingTeams = initialLotteryTeams
        .filter(team => !top4WinningSeeds.includes(team.seed))
        .sort((a, b) => a.seed - b.seed);

    const finalOrder = [...lotteryWinners, ...remainingTeams];
    renderSimulatedResults(finalOrder);
}

// --- UI AND EVENT HANDLING ---

const buttonContainer = document.getElementById('button-container');

function renderInitialButtons() {
    buttonContainer.innerHTML = `
        <button id="simulateBtn" class="action-button w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 disabled:bg-gray-400">
            Simulate Lottery
        </button>
    `;
}

function renderSimulatedButtons() {
    buttonContainer.innerHTML = `
        <button id="simulateAgainBtn" class="action-button w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">
            Simulate Again
        </button>
        <button id="resetBtn" class="action-button w-full sm:w-auto bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">
            Reset
        </button>
    `;
}

function resetView() {
    document.getElementById('table-title').textContent = 'Lottery Odds';
    document.getElementById('table-description').textContent = 'Odds for the 14 non-playoff teams to land a top 4 pick in the upcoming draft.';
    renderLotteryOddsTable();
    renderInitialButtons();
}

function handleFirstSimulation() {
    document.getElementById('table-title').textContent = 'Lottery Results';
    document.getElementById('table-description').textContent = 'The official draft order based on the simulation.';
    runSimulation();
    renderSimulatedButtons();
}

function setupButtonListeners() {
    buttonContainer.addEventListener('click', (event) => {
        const button = event.target.closest('button');
        if (!button) return;

        const buttonId = button.id;
        if (buttonId === 'simulateBtn') {
            handleFirstSimulation();
        } else if (buttonId === 'simulateAgainBtn') {
            runSimulation();
        } else if (buttonId === 'resetBtn') {
            resetView();
        }
    });
}


// --- INITIALIZATION ---
async function initializeApp() {
    document.getElementById('lottery-table-body').innerHTML = `
        <tr><td colspan="5" class="text-center p-8"><div class="font-semibold text-gray-500">Loading Team Data...</div></td></tr>`;
    renderTableHeader();
    renderInitialButtons();
    document.getElementById('simulateBtn').disabled = true;

    const [allTeams, draftPicks] = await Promise.all([
        fetchSheetData('Teams'),
        fetchSheetData('Draft_Capital')
    ]);

    if (!allTeams || !draftPicks) {
        document.getElementById('lottery-table-body').innerHTML = `
            <tr><td colspan="5" class="text-center p-8 text-red-600 font-semibold">Failed to load required data. Please try again later.</td></tr>`;
        renderInitialButtons(); // Render buttons even on fail, but they will be disabled.
        return;
    }

    const sortedTeams = allTeams
        .filter(t => t.team_id && t.team_id !== 'RETIRED' && t.team_id !== 'FREE_AGENT')
        .map(t => ({ ...t, wins: parseInt(t.wins, 10), losses: parseInt(t.losses, 10) }))
        .sort((a, b) => a.wins - b.wins || a.team_name.localeCompare(b.team_name));

    initialLotteryTeams = sortedTeams.slice(0, 14).map((team, index) => ({
        ...team,
        seed: index + 1,
        ...lotteryOdds[index]
    }));

    teamDataMap = allTeams.reduce((acc, team) => {
        acc[team.team_id] = team;
        return acc;
    }, {});
    
    draftPicks.filter(p => parseInt(p.season) === DRAFT_SEASON && parseInt(p.round) === 1)
        .forEach(pick => { pickOwnership[pick.original_team] = pick.current_owner; });

    renderLotteryOddsTable();
    document.getElementById('simulateBtn').disabled = false;
    setupButtonListeners();
}

document.addEventListener('DOMContentLoaded', initializeApp);

</script>

</body>
</html>
