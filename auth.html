<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Authentication Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        h2 { text-align: center; color: #333; }
        .auth-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .auth-section:last-child { border-bottom: none; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="password"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #5cb85c; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; }
        button:hover { background-color: #4cae4c; }
        .message { text-align: center; padding: 10px; margin-top: 10px; border-radius: 4px; }
        .success { background-color: #dff0d8; color: #3c763d; }
        .error { background-color: #f2dede; color: #a94442; }
        .admin-info { background-color: #f9f9f9; padding: 15px; border-radius: 4px; margin-top: 20px; }
        .admin-info ul { list-style-type: none; padding: 0; }
        .admin-info li { background-color: #e9e9e9; margin-bottom: 5px; padding: 8px; border-radius: 3px; }
        #logoutButton { background-color: #d9534f; margin-top: 20px; }
        #logoutButton:hover { background-color: #c9302c; }
        .logged-in-as { text-align: center; margin-bottom: 15px; font-weight: bold; }
    </style>
    <script>
        // Define ADMIN_PASSWORD for the admin query parameter check.
        // WARNING: Hardcoding passwords in client-side JS is insecure. For demo only.
        const ADMIN_PASSWORD = "potato-alfalfa-kumquat-zebra"; // Keep your admin password
    </script>
</head>
<body>
    <div class="container">
        <div id="main-content">
            <div id="registration-section" class="auth-section">
                <h2>Register New Account</h2>
                <div>
                    <label for="regUsername">Username:</label>
                    <input type="text" id="regUsername" placeholder="Choose a username">
                </div>
                <div>
                    <label for="regPassword">Password:</label>
                    <input type="password" id="regPassword" placeholder="Choose a password">
                </div>
                <div>
                    <label for="regPasswordConfirm">Confirm Password:</label>
                    <input type="password" id="regPasswordConfirm" placeholder="Confirm your password">
                </div>
                <button id="registerButton">Register</button>
                <p id="registrationMessage" class="message" style="display:none;"></p>
            </div>

            <div id="login-section" class="auth-section">
                <h2>Login to Your Account</h2>
                <div>
                    <label for="loginUsername">Username:</label>
                    <input type="text" id="loginUsername" placeholder="Enter your username">
                </div>
                <div>
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <button id="loginButton">Login</button>
                <p id="loginMessage" class="message" style="display:none;"></p>
            </div>
        </div>

        <div id="protected-content-section" style="display:none;">
            <p class="logged-in-as">Logged in as: <span id="loggedInUserDisplay"></span></p>
            <h2>Welcome!</h2>
            <p>This is a protected area. You are successfully logged in.</p>
            <p><a href="home.html">Go to Home Page (example protected page)</a></p>
            <button id="logoutButton">Logout</button>
        </div>
        
        <div id="admin-section" style="display:none;" class="admin-info">
            <h2>Admin Information</h2>
            <p>This section is visible when accessed with the correct admin URL parameter.</p>
            <h3>Registered Users:</h3>
            <ul id="userList">
                <li>No users found or unable to load.</li>
            </ul>
            <p><small>Note: This lists usernames only. For demo purposes.</small></p>
            <button id="adminLogoutButton">Logout (from Admin View)</button>
        </div>
    </div>

    <script src="auth-middleware.js"></script>
    <script>
        // auth.html specific UI logic
        document.addEventListener('DOMContentLoaded', function() {
            const authManager = window.AuthManager; // Get the manager from auth-middleware.js

            // Section elements
            const registrationSect = document.getElementById('registration-section');
            const loginSect = document.getElementById('login-section');
            const protectedSect = document.getElementById('protected-content-section');
            const adminSect = document.getElementById('admin-section');
            const mainContent = document.getElementById('main-content'); // Wrapper for reg/login

            // Message elements
            const regMsg = document.getElementById('registrationMessage');
            const loginMsg = document.getElementById('loginMessage');
            const loggedInUserDisplay = document.getElementById('loggedInUserDisplay');

            // Buttons
            const registerBtn = document.getElementById('registerButton');
            const loginBtn = document.getElementById('loginButton');
            const logoutBtn = document.getElementById('logoutButton');
            const adminLogoutBtn = document.getElementById('adminLogoutButton');
            
            // Inputs
            const regUsernameInput = document.getElementById('regUsername');
            const regPasswordInput = document.getElementById('regPassword');
            const regPasswordConfirmInput = document.getElementById('regPasswordConfirm');
            const loginUsernameInput = document.getElementById('loginUsername');
            const loginPasswordInput = document.getElementById('loginPassword');

            function showMessage(element, message, isSuccess) {
                element.textContent = message;
                element.className = 'message ' + (isSuccess ? 'success' : 'error');
                element.style.display = 'block';
            }

            function hideMessage(element) {
                element.style.display = 'none';
            }

            function updateUIBasedOnAuthState() {
                const currentUser = authManager.getLoggedInUser();
                const urlParams = new URLSearchParams(window.location.search);
                const isAdminAccess = urlParams.has('admin') && urlParams.get('admin') === ADMIN_PASSWORD;

                if (isAdminAccess) {
                    mainContent.style.display = 'none';
                    registrationSect.style.display = 'none';
                    loginSect.style.display = 'none';
                    protectedSect.style.display = 'none';
                    adminSect.style.display = 'block';
                    loadAdminData();
                } else if (currentUser) {
                    mainContent.style.display = 'none';
                    registrationSect.style.display = 'none';
                    loginSect.style.display = 'none';
                    protectedSect.style.display = 'block';
                    adminSect.style.display = 'none';
                    loggedInUserDisplay.textContent = currentUser;
                } else {
                    mainContent.style.display = 'block';
                    registrationSect.style.display = 'block'; // Or show login first
                    loginSect.style.display = 'block';
                    protectedSect.style.display = 'none';
                    adminSect.style.display = 'none';
                }
            }
            
            async function handleRegistration() {
                hideMessage(regMsg);
                const username = regUsernameInput.value.trim();
                const password = regPasswordInput.value;
                const confirmPassword = regPasswordConfirmInput.value;

                if (!username || !password || !confirmPassword) {
                    showMessage(regMsg, 'All fields are required.', false);
                    return;
                }
                if (password !== confirmPassword) {
                    showMessage(regMsg, 'Passwords do not match.', false);
                    return;
                }

                try {
                    const success = await authManager.registerUser(username, password);
                    if (success) {
                        showMessage(regMsg, 'Registration successful! Please log in.', true);
                        regUsernameInput.value = '';
                        regPasswordInput.value = '';
                        regPasswordConfirmInput.value = '';
                         // Optionally switch to login view or clear form
                    }
                } catch (error) {
                    showMessage(regMsg, error.message, false);
                }
            }

            async function handleLogin() {
                hideMessage(loginMsg);
                const username = loginUsernameInput.value.trim();
                const password = loginPasswordInput.value;

                if (!username || !password) {
                    showMessage(loginMsg, 'Username and password are required.', false);
                    return;
                }

                try {
                    const success = await authManager.loginUser(username, password);
                    if (success) {
                        showMessage(loginMsg, 'Login successful! Loading your space...', true);
                        updateUIBasedOnAuthState(); // Update UI to show protected content
                        // Potentially redirect to another page if auth.html is only for login/reg
                        // window.location.href = 'home.html'; 
                    }
                } catch (error) {
                    showMessage(loginMsg, error.message, false);
                }
            }

            function handleLogout() {
                authManager.logoutUser();
                updateUIBasedOnAuthState(); // Update UI to show login/reg forms
                // Could redirect to a logged-out confirmation page or back to login
                // window.location.href = 'auth.html'; // Reload to ensure clean state
            }
            
            function loadAdminData() {
                const userListUl = document.getElementById('userList');
                userListUl.innerHTML = ''; // Clear existing
                try {
                    const users = authManager.getAllUsersForAdmin(); // Expects {username: data}
                    const usernames = Object.keys(users);
                    if (usernames.length > 0) {
                        usernames.forEach(username => {
                            const li = document.createElement('li');
                            li.textContent = username;
                            userListUl.appendChild(li);
                        });
                    } else {
                        userListUl.innerHTML = '<li>No users registered yet.</li>';
                    }
                } catch (e) {
                    console.error("Admin: Error loading users", e);
                    userListUl.innerHTML = '<li>Error loading user list.</li>';
                }
            }

            // Attach event listeners
            if (registerBtn) registerBtn.addEventListener('click', handleRegistration);
            if (loginBtn) loginBtn.addEventListener('click', handleLogin);
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', handleLogout); // Admin logout also logs out user

            // Initial UI setup
            updateUIBasedOnAuthState();
            
            // Handle page protection for other pages (if user navigates away and comes back)
            // This assumes auth-middleware.js also has its own page protection logic for non-auth pages
            // For auth.html itself, the logic above handles visibility of sections.
            // If not admin and already logged in, maybe redirect from auth.html.
            const currentUser = authManager.getLoggedInUser();
            const urlParams = new URLSearchParams(window.location.search);
            const isAdminAccess = urlParams.has('admin') && urlParams.get('admin') === ADMIN_PASSWORD;
            const redirectTarget = urlParams.get('redirect');

            if (currentUser && !isAdminAccess) {
                if (redirectTarget) {
                    // If there was a redirect target (e.g. tried to access protected page)
                    // window.location.href = decodeURIComponent(redirectTarget);
                    // For now, if on auth.html and logged in, just show protected content area
                    // or user can navigate via links.
                    console.log("User is logged in. On auth.html, showing protected content section if applicable.");
                } else {
                    // If just landing on auth.html and already logged in, show protected content
                    // This is handled by updateUIBasedOnAuthState
                }
            }
        });
    </script>
</body>
</html>
