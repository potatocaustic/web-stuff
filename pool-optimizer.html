<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pool Optimizer - caustic.info</title>
    <link rel="icon" href="https://raw.githubusercontent.com/potatocaustic/web-stuff/refs/heads/main/favicon.ico" type="image/x-icon" />
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            line-height: 1.6;
        }
        
        h1, h2, h3, h4 {
            color: #333;
        }

        /* Header and Navigation */
        header {
            background-color: #333;
            color: #fff;
            padding: 1rem;
            text-align: center;
        }
        
        header h1 {
            color: white !important;
            font-size: 1.5rem;
            margin: 0;
        }
        
        nav ul {
          display: flex;
          justify-content: center;
          list-style: none;
          margin-top: 1rem;
          flex-wrap: wrap;
        }
        
        nav ul li {
          margin: 0.5rem 1rem;
        }
        
        nav ul li a {
          color: #fff;
          text-decoration: none;
          font-size: 1.1rem;
          transition: color 0.3s ease;
          white-space: nowrap;
        }
        
        nav ul li a:hover {
          color: #ccc;
        }
        
        /* Mobile navigation styles */
        @media (max-width: 600px) {
          nav {
            width: 100%;
            padding: 0;
          }
          
          nav ul {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 0;
            width: 100%;
            margin-left: 0;
            margin-right: 0;
          }
          
          nav ul li {
            margin: 0.2rem 0;
            width: 100%;
            text-align: center;
          }
          
          nav ul li a {
            display: block;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            margin: 0 auto;
          }
          
          nav ul li:last-child a {
            border-bottom: none;
          }
        }

        /* Main Content */
        main {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            display: none; /* Hide main content initially for auth */
        }

        main.visible { /* Class to show main content, added by auth.js */
            display: block;
        }
        
        /* Card Styles */
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .input, select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Button Styles */
        .button {
            display: inline-block;
            background-color: #333;
            color: #fff;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            text-decoration: none;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
            width: 100%;
            text-align: center;
        }
        
        .button:hover {
            background-color: #555;
        }

        .button-secondary {
            background-color: #6c757d;
        }

        .button-secondary:hover {
            background-color: #5a6268;
        }

        .button-danger {
            background-color: #dc3545;
        }
        
        .button-danger:hover {
            background-color: #c82333;
        }

        /* Results */
        #results-container {
            margin-top: 2rem;
        }

        #best-result {
            background-color: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 1rem;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            background-color: #333;
            color: #fff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <header>
        <h1>Pool Optimizer</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="../RKL/rkl-stats.html">Jammers Stats</a></li>
                <li><a href="PSPs/mlb-psp.html">MLB PSP Database</a></li>
                <li><a href="PSPs-WNBA/wnba-psp.html">WNBA PSP Database</a></li>
                <li><a href="karma-calculator.html">Karma EV Calculator</a></li>
                <li><a href="pool-optimizer.html">Pool Optimizer</a></li>
            </ul>
        </nav>
    </header>
    <div id="auth-container" style="padding: 2rem; max-width: 400px; margin: 2rem auto; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
      <h2 id="auth-title">Login</h2>
      <p id="auth-error" style="color: red; margin-bottom: 1rem; min-height: 1.2em;"></p>

      <div id="login-form">
        <input type="text" id="login-username" placeholder="Username" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        <input type="password" id="login-password" placeholder="Password" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        <button id="login-button" class="button">Login</button>
        <p style="margin-top: 1rem;">Don't have an account? <a href="#" id="show-signup">Sign Up</a></p>
      </div>

      <div id="signup-form" style="display: none;">
        <input type="text" id="signup-username" placeholder="Choose Username" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        <input type="password" id="signup-password" placeholder="Choose Password" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        <input type="password" id="signup-confirm-password" placeholder="Confirm Password" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        <button id="signup-button" class="button" style="background-color: #5cb85c;">Sign Up</button>
        <p style="margin-top: 1rem;">Already have an account? <a href="#" id="show-login">Login</a></p>
      </div>
    </div>
    <main>
        <div id="app">
            <div class="card">
                <div class="grid-container">
                    <div>
                        <h3>Setup</h3>
                        <div class="input-group">
                            <label for="betting-type" class="label">Betting Type</label>
                            <select id="betting-type" class="input">
                                <option value="ML">ML</option>
                                <option value="Spread">Spread</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="pool-mode" class="label">Pool Mode</label>
                            <select id="pool-mode" class="input">
                                <option value="Pregame">Pregame</option>
                                <option value="Live">Live</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="num-games" class="label">Number of Games</label>
                            <select id="num-games" class="input">
                                <option value="0" disabled selected>Select</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <button id="submit-btn" class="button">Run Optimizer</button>
                        </div>
                    </div>

                    <div>
                        <h3>Save & Load Scenarios</h3>
                        <div class="input-group">
                            <label for="save-name" class="label">Save Name</label>
                            <input type="text" id="save-name" placeholder="e.g., 'Tuesday Night Slate'" class="input">
                        </div>
                        <div class="input-group">
                            <button id="save-btn" class="button button-secondary">Save</button>
                        </div>
                        <div class="input-group">
                            <label for="saved-files-dropdown" class="label">Load or Delete Saved File</label>
                            <select id="saved-files-dropdown" class="input"></select>
                        </div>
                        <div class="grid-container" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <button id="load-btn" class="button button-secondary">Load</button>
                            <button id="delete-btn" class="button button-danger">Delete</button>
                        </div>
                    </div>
                </div>
            </div>


            <div id="games-container"></div>
            
            <div id="results-container" class="hidden">
                 <div class="card">
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Optimal Strategy</h2>
                    <div id="best-result"></div>
                </div>
                <div class="card">
                    <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Detailed Results</h3>
                    <div id="all-results"></div>
                </div>
            </div>
             <div id="loading-indicator" class="hidden text-center p-8">
                <p style="font-size: 1.25rem;">Calculating optimal strategies...</p>
            </div>
        </div>
    </main>
    <footer class="text-center mt-8 py-4 bg-gray-800 text-white">
        <p>&copy; caustic.info</p>
    </footer>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>

    <script src="auth.js"></script>
    <script>
        // --- APPLICATION LOGIC ---
        const bettingTypeSelect = document.getElementById('betting-type');
        const poolModeSelect = document.getElementById('pool-mode');
        const numGamesSelect = document.getElementById('num-games');
        const gamesContainer = document.getElementById('games-container');
        const submitBtn = document.getElementById('submit-btn');
        const saveNameInput = document.getElementById('save-name');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const savedFilesDropdown = document.getElementById('saved-files-dropdown');
        const resultsContainer = document.getElementById('results-container');
        const bestResultDiv = document.getElementById('best-result');
        const allResultsDiv = document.getElementById('all-results');
        const loadingIndicator = document.getElementById('loading-indicator');
        const STORAGE_PREFIX = 'poolOptimizer_';

        function populateSavedFilesDropdown() {
            savedFilesDropdown.innerHTML = '';
            let hasFiles = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(STORAGE_PREFIX)) {
                    hasFiles = true;
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key.replace(STORAGE_PREFIX, '');
                    savedFilesDropdown.appendChild(option);
                }
            }
            if (!hasFiles) {
                const option = document.createElement('option');
                option.textContent = 'No saved files';
                option.disabled = true;
                savedFilesDropdown.appendChild(option);
            }
        }

        document.addEventListener('DOMContentLoaded', populateSavedFilesDropdown);

        numGamesSelect.addEventListener('change', () => {
            const numGames = parseInt(numGamesSelect.value);
            if (numGames > 0) {
                renderGameInputs(numGames);
            }
        });

        poolModeSelect.addEventListener('change', () => {
             const numGames = parseInt(numGamesSelect.value);
             if (numGames > 0) {
                renderGameInputs(numGames);
             }
        });
        
        bettingTypeSelect.addEventListener('change', () => {
            const numGames = parseInt(numGamesSelect.value);
             if (numGames > 0) {
                renderGameInputs(numGames);
             }
        });

        function renderGameInputs(numGames) {
            gamesContainer.innerHTML = '';
            const isLiveMode = poolModeSelect.value === 'Live';
            const isSpread = bettingTypeSelect.value === 'Spread';

            for (let i = 1; i <= numGames; i++) {
                const gameDiv = document.createElement('div');
                gameDiv.id = `game-${i}-card`;
                gameDiv.className = 'card';
                
                const awayBettingOddsHTML = !isSpread ? `<div><label class="label">Away Betting Odds (American)</label><input id="away_american_odds_${i}" type="number" class="input" value="-110"></div>` : `<input type="hidden" id="away_american_odds_${i}" value="100">`;
                const homeBettingOddsHTML = !isSpread ? `<div><label class="label">Home Betting Odds (American)</label><input id="home_american_odds_${i}" type="number" class="input" value="-110"></div>` : `<input type="hidden" id="home_american_odds_${i}" value="100">`;

                gameDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="font-size: 1.25rem; font-weight: bold;">Game ${i}</h3>
                        ${isLiveMode ? `<button id="lock-btn-${i}" class="button button-secondary" style="width: auto; padding: 0.5rem 1rem;">Lock Game</button>` : ''}
                    </div>
                    <div class="grid-container">
                        <div>
                            <h4 style="text-align: center; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; margin-bottom: 1rem;">Away Team</h4>
                            <div class="input-group"><label class="label">Away Vote Share (%)</label><input id="away_vote_share_${i}" type="number" class="input" value="50"></div>
                            <div class="input-group"><label class="label">Away Vote Total</label><input id="away_votes_${i}" type="number" class="input" value="1000"></div>
                            ${awayBettingOddsHTML}
                            <div class="input-group"><label class="label">Away Vegas Odds (Decimal)</label><input id="away_vegas_odds_${i}" type="number" step="0.01" class="input" value="1.91"></div>
                        </div>

                        <div>
                             <h4 style="text-align: center; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; margin-bottom: 1rem;">Home Team</h4>
                            <div class="input-group"><label class="label">Home Vote Share (%)</label><input id="home_vote_share_${i}" type="number" class="input" value="50"></div>
                            <div class="input-group"><label class="label">Home Vote Total</label><input id="home_votes_${i}" type="number" class="input" value="1000"></div>
                            ${homeBettingOddsHTML}
                            <div class="input-group"><label class="label">Home Vegas Odds (Decimal)</label><input id="home_vegas_odds_${i}" type="number" step="0.01" class="input" value="1.91"></div>
                        </div>
                    </div>
                    <div id="locked-inputs-${i}" class="grid-container hidden" style="margin-top: 1rem;">
                         <div class="input-group">
                            <label class="label">Team Chosen</label>
                            <select id="team_chosen_${i}" class="input">
                                <option value="Home">Home</option>
                                <option value="Away">Away</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="label">Bet Size</label>
                            <select id="bet_size_${i}" class="input">
                                <option value="Zero">Zero (10)</option>
                                <option value="Max">Max (100)</option>
                            </select>
                        </div>
                    </div>
                `;
                gamesContainer.appendChild(gameDiv);
                
                if (isLiveMode) {
                    const lockBtn = document.getElementById(`lock-btn-${i}`);
                    const lockedInputs = document.getElementById(`locked-inputs-${i}`);
                    const gameCard = document.getElementById(`game-${i}-card`);

                    lockBtn.addEventListener('click', () => {
                        lockedInputs.classList.toggle('hidden');
                        gameCard.style.backgroundColor = lockedInputs.classList.contains('hidden') ? '#fff' : '#e6f7ff';
                        lockBtn.textContent = lockedInputs.classList.contains('hidden') ? 'Lock Game' : 'Unlock Game';
                    });
                }
            }
        }
        
        // --- Optimizer Logic (Ported from Python) ---
        const participationRate = 50.0;
        const zeroBetsAllowed = 'YES';

        function calculateTki(participationRate, minVoteTotal) {
            const participants = Math.floor(participationRate * minVoteTotal / 100);
            return [participants * 100, participants];
        }

        function calculatePayouts(tki, winners1st, winners2nd = 0, num_games) {
            if (winners1st === 0) return [0, 0];
            if (winners1st > tki) winners1st = tki;

            if (winners2nd === 0) {
                 const maxPayout = num_games === 3 ? 600 : (num_games === 2 ? 400 : 800);
                return [Math.min(maxPayout, Math.floor(tki / winners1st)), 0];
            }
            
            const ed = tki / (winners1st + winners2nd);
            if (ed >= 600) {
                 return [800, 600];
            }

            const haircut = winners1st / (winners1st + winners2nd);
            const payout2nd = ed - (ed * haircut);
            const remainder = tki - (payout2nd * winners2nd);
            const payout1st = Math.min(800, Math.floor(remainder / winners1st));

            return [payout1st, payout2nd];
        }

        function expectedValue(probability, odds, betType) {
            const wager = betType === 'Max' ? 100 : 10;
            if (betType === 'Zero') return probability * ((odds > 0 ? (odds/100) * 10 : (-100/odds) * 10));

            const betWin = odds > 0 ? (odds / 100) * wager : (-100 / odds) * wager;
            const loss = wager;
            return probability * betWin - (1 - probability) * loss;
        }

        function getCombinations(n, locked) {
            const teams = ['home', 'away'];
            let allCombos = [];
            
            function generate(index, currentCombo) {
                if (index === n) {
                    allCombos.push(currentCombo);
                    return;
                }

                if (locked[index]) {
                     generate(index + 1, [...currentCombo, locked[index].team.toLowerCase()]);
                } else {
                    for (const team of teams) {
                        generate(index + 1, [...currentCombo, team]);
                    }
                }
            }

            generate(0, []);
            return allCombos;
        }

        async function optimizeWagers(numGames, gameData, lockedGames) {
            return new Promise(resolve => {
                setTimeout(() => { 
                    if (gameData.some(g => isNaN(g.home_votes) || isNaN(g.away_votes))) {
                         resolve({ bestCombination: null, allResults: [] }); 
                         return;
                    }
                    const minVoteTotal = Math.min(...gameData.map(g => g.home_votes + g.away_votes));
                    if (minVoteTotal === 0 || isNaN(minVoteTotal)) {
                        resolve({ bestCombination: null, allResults: [] });
                        return;
                    }

                    const [tki, participants] = calculateTki(participationRate, minVoteTotal);

                    let bestCombination = null;
                    let bestEv = -Infinity;
                    let allResults = [];
                    
                    const picksCombinations = getCombinations(numGames, lockedGames);

                    for (const picks of picksCombinations) {
                        let correctProb = 1.0;
                        let voteShareFactor = 1.0;
                        for (let i = 0; i < picks.length; i++) {
                            const pick = picks[i];
                            correctProb *= gameData[i][`${pick}_prob`] / 100.0;
                            voteShareFactor *= gameData[i][`${pick}_vote_share`] / 100.0;
                        }

                        const expectedWinners1st = Math.max(1, Math.round(participants * voteShareFactor));
                        let expectedWinners2nd = 0;
                        let secondPlaceProb = 0;
                        
                        if (numGames === 4) {
                            for (let i = 0; i < numGames; i++) {
                                const oppositePick = picks[i] === 'home' ? 'away' : 'home';
                                const prob3of4 = (correctProb / (gameData[i][`${picks[i]}_prob`] / 100.0)) * (gameData[i][`${oppositePick}_prob`] / 100.0);
                                secondPlaceProb += prob3of4;
                            }
                             expectedWinners2nd = Math.max(1, Math.floor(participants * secondPlaceProb));
                        }
                        
                        const [payout1st, payout2nd] = calculatePayouts(tki, expectedWinners1st, expectedWinners2nd, numGames);
                        let totalBetEv = 0;
                        let betDecisions = [];
                        
                        for (let i = 0; i < picks.length; i++) {
                            const game = gameData[i];
                            const pick = picks[i];
                            const odds = game[`${pick}_odds`];
                            const probability = game[`${pick}_prob`] / 100;
                            let betType, betEv;

                            if (lockedGames[i]) {
                                betType = lockedGames[i].bet;
                                betEv = expectedValue(probability, odds, betType);
                            } else {
                                const evMax = expectedValue(probability, odds, 'Max');
                                const evZero = expectedValue(probability, odds, 'Zero');
                                if (zeroBetsAllowed === 'NO' || evMax > evZero) {
                                    betType = 'Max';
                                    betEv = evMax;
                                } else {
                                    betType = 'Zero';
                                    betEv = evZero;
                                }
                            }
                            
                            betDecisions.push({ pick: pick, bet: betType, ev: betEv });
                            totalBetEv += betEv;
                        }
                        
                        let poolEv;
                        if (numGames === 4) {
                            poolEv = (correctProb * payout1st) + (secondPlaceProb * payout2nd) - 100;
                        } else {
                            poolEv = (correctProb * payout1st) - 100;
                        }
                        
                        const totalEv = totalBetEv + poolEv;

                        allResults.push({
                            picks, totalEv, betEv: totalBetEv, poolEv, 
                            details: { correctProb, winners1st: expectedWinners1st, winners2nd: expectedWinners2nd, payout1st, payout2nd, betDecisions }
                        });
                        
                        if (totalEv > bestEv) {
                            bestEv = totalEv;
                            bestCombination = {
                                picks, totalEv, betEv: totalBetEv, poolEv, details: { betDecisions }
                            };
                        }
                    }
                    
                    allResults.sort((a, b) => b.totalEv - a.totalEv);

                    resolve({ bestCombination, allResults });
                }, 50);
            });
        }
        
        submitBtn.addEventListener('click', async () => {
            const numGames = parseInt(numGamesSelect.value);
            if(numGames === 0 || isNaN(numGames)) {
                alert("Please select the number of games.");
                return;
            }

            resultsContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            const gameData = [];
            const lockedGames = {};

            for (let i = 1; i <= numGames; i++) {
                const homeVoteShare = parseFloat(document.getElementById(`home_vote_share_${i}`).value);
                const awayVoteShare = parseFloat(document.getElementById(`away_vote_share_${i}`).value);
                const homeVotes = parseInt(document.getElementById(`home_votes_${i}`).value);
                const awayVotes = parseInt(document.getElementById(`away_votes_${i}`).value);
                const homeVegasOdds = parseFloat(document.getElementById(`home_vegas_odds_${i}`).value);
                const awayVegasOdds = parseFloat(document.getElementById(`away_vegas_odds_${i}`).value);
                const homeAmericanOdds = parseInt(document.getElementById(`home_american_odds_${i}`).value);
                const awayAmericanOdds = parseInt(document.getElementById(`away_american_odds_${i}`).value);

                if (isNaN(homeVegasOdds) || isNaN(awayVegasOdds) || homeVegasOdds <= 0 || awayVegasOdds <= 0) {
                    alert(`Please enter valid decimal odds for Game ${i}.`);
                    loadingIndicator.classList.add('hidden');
                    return;
                }

                const homeProb = (1 / homeVegasOdds) / ((1 / homeVegasOdds) + (1 / awayVegasOdds)) * 100;

                gameData.push({
                    home_vote_share: homeVoteShare, away_vote_share: awayVoteShare,
                    home_votes: homeVotes, away_votes: awayVotes,
                    home_prob: homeProb, away_prob: 100 - homeProb,
                    home_odds: homeAmericanOdds, away_odds: awayAmericanOdds
                });
                
                const lockBtn = document.getElementById(`lock-btn-${i}`);
                if (lockBtn && !document.getElementById(`locked-inputs-${i}`).classList.contains('hidden')) {
                    lockedGames[i-1] = {
                        team: document.getElementById(`team_chosen_${i}`).value,
                        bet: document.getElementById(`bet_size_${i}`).value
                    }
                }
            }

            const { bestCombination, allResults } = await optimizeWagers(numGames, gameData, lockedGames);
            
            loadingIndicator.classList.add('hidden');
            displayResults(bestCombination, allResults);
        });
        
        function displayResults(best, all) {
            if (!best) {
                bestResultDiv.innerHTML = `<p style="color: #dc3545; font-weight: bold;">Could not calculate results. Please check your inputs, especially the vote totals.</p>`;
                allResultsDiv.innerHTML = '';
                resultsContainer.classList.remove('hidden');
                return;
            }
            resultsContainer.classList.remove('hidden');

            let bestHtml = `<p><strong>Best Total EV (Pool EV + Bet EV):</strong> <span style="font-weight: bold; color: #1890ff;">${best.totalEv.toFixed(2)}</span></p>`;
            bestHtml += `<p><strong>Pool EV:</strong> ${best.poolEv.toFixed(2)}, <strong>Bet EV:</strong> ${best.betEv.toFixed(2)}</p>`;
            if (best.poolEv < 0) {
                bestHtml += `<p style="margin-top: 0.5rem; color: #dc3545; font-weight: bold;">Do not enter the pool. The Pool EV for the best combination is negative.</p>`;
            }
            bestHtml += '<h4 style="font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem;">Recommended Selections:</h4>';
            best.details.betDecisions.forEach((d, i) => {
                bestHtml += `<div><strong>Game ${i + 1}:</strong> Pick <span style="font-weight: bold;">${d.pick.toUpperCase()}</span>, Bet <span style="font-weight: bold;">${d.bet.toUpperCase()}</span></div>`;
            });
            bestResultDiv.innerHTML = bestHtml;

            allResultsDiv.innerHTML = '';
            all.forEach(res => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.padding = '1rem';
                card.style.marginBottom = '1rem';
                let detailsHtml = `<h4 style="font-weight: bold; font-size: 1.1rem;">${res.picks.join(', ').toUpperCase()}</h4>`;
                detailsHtml += `<p><strong>Total EV: ${res.totalEv.toFixed(2)}</strong> (Pool: ${res.poolEv.toFixed(2)}, Bet: ${res.betEv.toFixed(2)})</p>`;
                detailsHtml += `<p style="font-size: 0.9rem; color: #666;">Win Prob: ${(res.details.correctProb * 100).toFixed(2)}% | 1st Place Winners: ${res.details.winners1st} | Payout: $${res.details.payout1st.toFixed(2)}</p>`;
                
                res.details.betDecisions.forEach((d, i) => {
                    detailsHtml += `<p style="font-size: 0.9rem; color: #888; margin-left: 1rem;">Game ${i + 1}: Pick ${d.pick.toUpperCase()}, Bet ${d.bet.toUpperCase()} (EV: ${d.ev.toFixed(2)})</p>`;
                });
                card.innerHTML = detailsHtml;
                allResultsDiv.appendChild(card);
            });
        }

        // --- SAVE/LOAD FUNCTIONALITY ---
        saveBtn.addEventListener('click', () => {
            const saveName = saveNameInput.value.trim();
            if (!saveName) {
                alert("Please enter a name for your save file.");
                return;
            }
            const numGames = parseInt(numGamesSelect.value);
            if (numGames === 0 || isNaN(numGames)) {
                alert("Please select the number of games before saving.");
                return;
            }

            const dataToSave = {
                bettingType: bettingTypeSelect.value,
                poolMode: poolModeSelect.value,
                numGames: numGames,
                games: []
            };

            for (let i = 1; i <= numGames; i++) {
                const lockBtn = document.getElementById(`lock-btn-${i}`);
                const isLocked = lockBtn && !document.getElementById(`locked-inputs-${i}`).classList.contains('hidden');
                dataToSave.games.push({
                    home_vote_share: document.getElementById(`home_vote_share_${i}`).value,
                    away_vote_share: document.getElementById(`away_vote_share_${i}`).value,
                    home_votes: document.getElementById(`home_votes_${i}`).value,
                    away_votes: document.getElementById(`away_votes_${i}`).value,
                    home_vegas_odds: document.getElementById(`home_vegas_odds_${i}`).value,
                    away_vegas_odds: document.getElementById(`away_vegas_odds_${i}`).value,
                    home_american_odds: document.getElementById(`home_american_odds_${i}`).value,
                    away_american_odds: document.getElementById(`away_american_odds_${i}`).value,
                    isLocked: isLocked,
                    team_chosen: isLocked ? document.getElementById(`team_chosen_${i}`).value : 'Home',
                    bet_size: isLocked ? document.getElementById(`bet_size_${i}`).value : 'Zero'
                });
            }
            try {
                localStorage.setItem(STORAGE_PREFIX + saveName, JSON.stringify(dataToSave));
                alert(`Inputs saved as "${saveName}"!`);
                populateSavedFilesDropdown();
            } catch (error) {
                console.error("Error saving data to localStorage: ", error);
                alert("Failed to save inputs. Your browser might not support local storage or it might be full.");
            }
        });
        
        loadBtn.addEventListener('click', () => {
            const selectedFileKey = savedFilesDropdown.value;
            if (!selectedFileKey || savedFilesDropdown.options[savedFilesDropdown.selectedIndex]?.disabled) {
                alert("Please select a valid file to load.");
                return;
            }
            try {
                const savedData = localStorage.getItem(selectedFileKey);

                if (savedData) {
                    const data = JSON.parse(savedData);
                    bettingTypeSelect.value = data.bettingType;
                    poolModeSelect.value = data.poolMode;
                    numGamesSelect.value = data.numGames;
                    renderGameInputs(data.numGames);

                    setTimeout(() => {
                        data.games.forEach((game, index) => {
                            const i = index + 1;
                            document.getElementById(`home_vote_share_${i}`).value = game.home_vote_share;
                            document.getElementById(`away_vote_share_${i}`).value = game.away_vote_share;
                            document.getElementById(`home_votes_${i}`).value = game.home_votes;
                            document.getElementById(`away_votes_${i}`).value = game.home_vegas_odds_${i}`).value = game.home_vegas_odds;
                            document.getElementById(`away_vegas_odds_${i}`).value = game.away_vegas_odds;
                            
                            const homeOddsInput = document.getElementById(`home_american_odds_${i}`);
                            if(homeOddsInput) homeOddsInput.value = game.home_american_odds;

                            const awayOddsInput = document.getElementById(`away_american_odds_${i}`);
                            if(awayOddsInput) awayOddsInput.value = game.away_american_odds;
                            
                            const lockBtn = document.getElementById(`lock-btn-${i}`);
                            if (game.isLocked && lockBtn) {
                                const lockedInputs = document.getElementById(`locked-inputs-${i}`);
                                if (lockedInputs.classList.contains('hidden')) {
                                   lockBtn.click();
                                }
                                document.getElementById(`team_chosen_${i}`).value = game.team_chosen;
                                document.getElementById(`bet_size_${i}`).value = game.bet_size;
                            }
                        });
                         saveNameInput.value = selectedFileKey.replace(STORAGE_PREFIX, '');
                        alert(`Inputs from "${selectedFileKey.replace(STORAGE_PREFIX, '')}" loaded successfully!`);
                    }, 100);

                } else {
                    alert("Could not find the selected file.");
                    populateSavedFilesDropdown();
                }
            } catch (error) {
                console.error("Error loading data from localStorage: ", error);
                alert("Failed to load inputs.");
            }
        });

        deleteBtn.addEventListener('click', () => {
            const selectedFileKey = savedFilesDropdown.value;
            if (!selectedFileKey || savedFilesDropdown.options[savedFilesDropdown.selectedIndex]?.disabled) {
                alert("Please select a valid file to delete.");
                return;
            }

            if (confirm(`Are you sure you want to delete "${selectedFileKey.replace(STORAGE_PREFIX, '')}"? This cannot be undone.`)) {
                localStorage.removeItem(selectedFileKey);
                alert("File deleted.");
                populateSavedFilesDropdown();
            }
        });

    </script>
</body>
</html>
