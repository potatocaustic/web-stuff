<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pool Optimizer - caustic.info</title>
    <link rel="icon" href="https://raw.githubusercontent.com/potatocaustic/web-stuff/refs/heads/main/favicon.ico" type="image/x-icon" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .info-card {
            background-color: #f9f9f9;
            border: 1px solid #eee;
        }
        .results-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
    <header class="bg-gray-800 text-white p-4 text-center">
        <h1 class="text-2xl font-bold">Pool Optimizer</h1>
        <nav class="mt-2">
            <ul class="flex justify-center space-x-4 flex-wrap">
                <li><a href="index.html" class="hover:text-gray-300">Home</a></li>
                <li><a href="../RKL/rkl-stats.html" class="hover:text-gray-300">Jammers Stats</a></li>
                <li><a href="PSPs/mlb-psp.html" class="hover:text-gray-300">MLB PSP Database</a></li>
                <li><a href="PSPs-WNBA/wnba-psp.html" class="hover:text-gray-300">WNBA PSP Database</a></li>
                <li><a href="karma-calculator.html" class="hover:text-gray-300">Karma EV Calculator</a></li>
                <li><a href="pool-optimizer.html" class="hover:text-gray-300">Pool Optimizer</a></li>
            </ul>
        </nav>
    </header>

    <main class="p-4 md:p-8 max-w-7xl mx-auto">
        <div id="app" class="space-y-6">
            <!-- Controls -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Setup</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="pool-mode" class="block text-sm font-medium text-gray-700 mb-1">Pool Mode</label>
                                <select id="pool-mode" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="Pregame">Pregame</option>
                                    <option value="Live">Live</option>
                                </select>
                            </div>
                            <div>
                                <label for="num-games" class="block text-sm font-medium text-gray-700 mb-1">Number of Games</label>
                                <select id="num-games" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="0" disabled selected>Select</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button id="submit-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 shadow-sm">Run Optimizer</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold mb-2">Save & Load Scenarios</h3>
                        <div class="space-y-3">
                            <div>
                                <label for="save-name" class="block text-sm font-medium text-gray-700 mb-1">Save Name</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="save-name" placeholder="e.g., 'Tuesday Night Slate'" class="w-full p-2 border rounded-md shadow-sm">
                                    <button id="save-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 shadow-sm whitespace-nowrap">Save</button>
                                </div>
                            </div>
                            <div>
                                <label for="saved-files-dropdown" class="block text-sm font-medium text-gray-700 mb-1">Load or Delete Saved File</label>
                                <div class="flex space-x-2">
                                    <select id="saved-files-dropdown" class="w-full p-2 border rounded-md shadow-sm"></select>
                                    <button id="load-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 shadow-sm">Load</button>
                                    <button id="delete-btn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 shadow-sm">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Game Inputs -->
            <div id="games-container" class="space-y-6"></div>
            
            <!-- Results -->
            <div id="results-container" class="hidden">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900">Optimal Strategy</h2>
                    <div id="best-result" class="p-4 rounded-md bg-indigo-50 border border-indigo-200"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-900">Detailed Results</h3>
                    <div id="all-results" class="space-y-4"></div>
                </div>
            </div>
             <div id="loading-indicator" class="hidden text-center p-8">
                <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-semibold">Calculating optimal strategies...</p>
            </div>
        </div>
    </main>
    <footer class="text-center mt-8 py-4 bg-gray-800 text-white">
        <p>&copy; caustic.info</p>
    </footer>

    <script>
        // --- APPLICATION LOGIC ---
        const poolModeSelect = document.getElementById('pool-mode');
        const numGamesSelect = document.getElementById('num-games');
        const gamesContainer = document.getElementById('games-container');
        const submitBtn = document.getElementById('submit-btn');
        const saveNameInput = document.getElementById('save-name');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const savedFilesDropdown = document.getElementById('saved-files-dropdown');
        const resultsContainer = document.getElementById('results-container');
        const bestResultDiv = document.getElementById('best-result');
        const allResultsDiv = document.getElementById('all-results');
        const loadingIndicator = document.getElementById('loading-indicator');
        const STORAGE_PREFIX = 'poolOptimizer_';

        function populateSavedFilesDropdown() {
            savedFilesDropdown.innerHTML = '';
            let hasFiles = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(STORAGE_PREFIX)) {
                    hasFiles = true;
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key.replace(STORAGE_PREFIX, '');
                    savedFilesDropdown.appendChild(option);
                }
            }
            if (!hasFiles) {
                const option = document.createElement('option');
                option.textContent = 'No saved files';
                option.disabled = true;
                savedFilesDropdown.appendChild(option);
            }
        }

        document.addEventListener('DOMContentLoaded', populateSavedFilesDropdown);

        numGamesSelect.addEventListener('change', () => {
            const numGames = parseInt(numGamesSelect.value);
            if (numGames > 0) {
                renderGameInputs(numGames);
            }
        });

        poolModeSelect.addEventListener('change', () => {
             const numGames = parseInt(numGamesSelect.value);
             if (numGames > 0) {
                renderGameInputs(numGames);
             }
        });

        function renderGameInputs(numGames) {
            gamesContainer.innerHTML = '';
            const isLiveMode = poolModeSelect.value === 'Live';

            for (let i = 1; i <= numGames; i++) {
                const gameDiv = document.createElement('div');
                gameDiv.id = `game-${i}-card`;
                gameDiv.className = 'p-6 rounded-lg shadow-md info-card';
                gameDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Game ${i}</h3>
                        ${isLiveMode ? `<button id="lock-btn-${i}" class="bg-gray-200 text-gray-800 py-1 px-3 rounded-md hover:bg-gray-300 text-sm">Lock Game</button>` : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div><label class="block text-sm">Home Vote Share (%)</label><input id="home_vote_share_${i}" type="number" class="w-full p-2 border rounded mt-1" value="50"></div>
                        <div><label class="block text-sm">Home Vote Total</label><input id="home_votes_${i}" type="number" class="w-full p-2 border rounded mt-1" value="1000"></div>
                        <div><label class="block text-sm">Away Vote Total</label><input id="away_votes_${i}" type="number" class="w-full p-2 border rounded mt-1" value="1000"></div>
                        <div><label class="block text-sm">Home Vegas Odds (Decimal)</label><input id="home_vegas_odds_${i}" type="number" step="0.01" class="w-full p-2 border rounded mt-1" value="1.91"></div>
                        <div><label class="block text-sm">Away Vegas Odds (Decimal)</label><input id="away_vegas_odds_${i}" type="number" step="0.01" class="w-full p-2 border rounded mt-1" value="1.91"></div>
                        <div><label class="block text-sm">Home Betting Odds (American)</label><input id="home_american_odds_${i}" type="number" class="w-full p-2 border rounded mt-1" value="-110"></div>
                        <div><label class="block text-sm">Away Betting Odds (American)</label><input id="away_american_odds_${i}" type="number" class="w-full p-2 border rounded mt-1" value="-110"></div>
                    </div>
                    <div id="locked-inputs-${i}" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 hidden">
                         <div>
                            <label class="block text-sm">Team Chosen</label>
                            <select id="team_chosen_${i}" class="w-full p-2 border rounded mt-1">
                                <option value="Home">Home</option>
                                <option value="Away">Away</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm">Bet Size</label>
                            <select id="bet_size_${i}" class="w-full p-2 border rounded mt-1">
                                <option value="Zero">Zero (10)</option>
                                <option value="Max">Max (100)</option>
                            </select>
                        </div>
                    </div>
                `;
                gamesContainer.appendChild(gameDiv);
                
                if (isLiveMode) {
                    const lockBtn = document.getElementById(`lock-btn-${i}`);
                    const lockedInputs = document.getElementById(`locked-inputs-${i}`);
                    const gameCard = document.getElementById(`game-${i}-card`);

                    lockBtn.addEventListener('click', () => {
                        lockedInputs.classList.toggle('hidden');
                        gameCard.classList.toggle('bg-blue-100');
                        gameCard.classList.toggle('border-blue-400');
                        lockBtn.textContent = lockedInputs.classList.contains('hidden') ? 'Lock Game' : 'Unlock Game';
                        lockBtn.classList.toggle('bg-blue-500');
                        lockBtn.classList.toggle('text-white');
                    });
                }
            }
        }
        
        // --- Optimizer Logic (Ported from Python) ---
        const participationRate = 50.0;
        const zeroBetsAllowed = 'YES';

        function calculateTki(participationRate, minVoteTotal) {
            const participants = Math.floor(participationRate * minVoteTotal / 100);
            return [participants * 100, participants];
        }

        function calculatePayouts(tki, winners1st, winners2nd = 0, num_games) {
            if (winners1st === 0) return [0, 0];
            if (winners1st > tki) winners1st = tki; // Cap winners to prevent payout issues

            if (winners2nd === 0) {
                 const maxPayout = num_games === 3 ? 600 : (num_games === 2 ? 400 : 800);
                return [Math.min(maxPayout, Math.floor(tki / winners1st)), 0];
            }
            
            const ed = tki / (winners1st + winners2nd);
            if (ed >= 600) {
                 return [800, 600];
            }

            const haircut = winners1st / (winners1st + winners2nd);
            const payout2nd = ed - (ed * haircut);
            const remainder = tki - (payout2nd * winners2nd);
            const payout1st = Math.min(800, Math.floor(remainder / winners1st));

            return [payout1st, payout2nd];
        }

        function expectedValue(probability, odds, betType) {
            const wager = betType === 'Max' ? 100 : 10;
            if (betType === 'Zero') return probability * ((odds > 0 ? (odds/100) * 10 : (-100/odds) * 10));

            const betWin = odds > 0 ? (odds / 100) * wager : (-100 / odds) * wager;
            const loss = wager;
            return probability * betWin - (1 - probability) * loss;
        }

        function getCombinations(n, locked) {
            const teams = ['home', 'away'];
            let allCombos = [];
            
            function generate(index, currentCombo) {
                if (index === n) {
                    allCombos.push(currentCombo);
                    return;
                }

                if (locked[index]) {
                     generate(index + 1, [...currentCombo, locked[index].team.toLowerCase()]);
                } else {
                    for (const team of teams) {
                        generate(index + 1, [...currentCombo, team]);
                    }
                }
            }

            generate(0, []);
            return allCombos;
        }

        async function optimizeWagers(numGames, gameData, lockedGames) {
            return new Promise(resolve => {
                setTimeout(() => { // Simulate async work
                    if (gameData.some(g => isNaN(g.home_votes) || isNaN(g.away_votes))) {
                         resolve({ bestCombination: null, allResults: [] }); 
                         return;
                    }
                    const minVoteTotal = Math.min(...gameData.map(g => g.home_votes + g.away_votes));
                    if (minVoteTotal === 0 || isNaN(minVoteTotal)) {
                        resolve({ bestCombination: null, allResults: [] });
                        return;
                    }

                    const [tki, participants] = calculateTki(participationRate, minVoteTotal);

                    let bestCombination = null;
                    let bestEv = -Infinity;
                    let allResults = [];
                    
                    const picksCombinations = getCombinations(numGames, lockedGames);

                    for (const picks of picksCombinations) {
                        let correctProb = 1.0;
                        let voteShareFactor = 1.0;
                        for (let i = 0; i < picks.length; i++) {
                            const pick = picks[i];
                            correctProb *= gameData[i][`${pick}_prob`] / 100.0;
                            voteShareFactor *= gameData[i][`${pick}_vote_share`] / 100.0;
                        }

                        const expectedWinners1st = Math.max(1, Math.round(participants * voteShareFactor));
                        let expectedWinners2nd = 0;
                        let secondPlaceProb = 0;
                        
                        if (numGames === 4) {
                            for (let i = 0; i < numGames; i++) {
                                const oppositePick = picks[i] === 'home' ? 'away' : 'home';
                                const prob3of4 = (correctProb / (gameData[i][`${picks[i]}_prob`] / 100.0)) * (gameData[i][`${oppositePick}_prob`] / 100.0);
                                secondPlaceProb += prob3of4;
                            }
                             expectedWinners2nd = Math.max(1, Math.floor(participants * secondPlaceProb));
                        }
                        
                        const [payout1st, payout2nd] = calculatePayouts(tki, expectedWinners1st, expectedWinners2nd, numGames);
                        let totalBetEv = 0;
                        let betDecisions = [];
                        
                        for (let i = 0; i < picks.length; i++) {
                            const game = gameData[i];
                            const pick = picks[i];
                            const odds = game[`${pick}_odds`];
                            const probability = game[`${pick}_prob`] / 100;
                            let betType, betEv;

                            if (lockedGames[i]) {
                                betType = lockedGames[i].bet;
                                betEv = expectedValue(probability, odds, betType);
                            } else {
                                const evMax = expectedValue(probability, odds, 'Max');
                                const evZero = expectedValue(probability, odds, 'Zero');
                                if (zeroBetsAllowed === 'NO' || evMax > evZero) {
                                    betType = 'Max';
                                    betEv = evMax;
                                } else {
                                    betType = 'Zero';
                                    betEv = evZero;
                                }
                            }
                            
                            betDecisions.push({ pick: pick, bet: betType, ev: betEv });
                            totalBetEv += betEv;
                        }
                        
                        let poolEv;
                        if (numGames === 4) {
                            poolEv = (correctProb * payout1st) + (secondPlaceProb * payout2nd) - 100;
                        } else {
                            poolEv = (correctProb * payout1st) - 100;
                        }
                        
                        const totalEv = totalBetEv + poolEv;

                        allResults.push({
                            picks, totalEv, betEv: totalBetEv, poolEv, 
                            details: { correctProb, winners1st: expectedWinners1st, winners2nd: expectedWinners2nd, payout1st, payout2nd, betDecisions }
                        });
                        
                        if (totalEv > bestEv) {
                            bestEv = totalEv;
                            bestCombination = {
                                picks, totalEv, betEv: totalBetEv, poolEv, details: { betDecisions }
                            };
                        }
                    }
                    
                    allResults.sort((a, b) => b.totalEv - a.totalEv);

                    resolve({ bestCombination, allResults });
                }, 50);
            });
        }
        
        submitBtn.addEventListener('click', async () => {
            const numGames = parseInt(numGamesSelect.value);
            if(numGames === 0 || isNaN(numGames)) {
                alert("Please select the number of games.");
                return;
            }

            resultsContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            const gameData = [];
            const lockedGames = {};

            for (let i = 1; i <= numGames; i++) {
                const homeVoteShare = parseFloat(document.getElementById(`home_vote_share_${i}`).value);
                const homeVotes = parseInt(document.getElementById(`home_votes_${i}`).value);
                const awayVotes = parseInt(document.getElementById(`away_votes_${i}`).value);
                const homeVegasOdds = parseFloat(document.getElementById(`home_vegas_odds_${i}`).value);
                const awayVegasOdds = parseFloat(document.getElementById(`away_vegas_odds_${i}`).value);
                const homeAmericanOdds = parseInt(document.getElementById(`home_american_odds_${i}`).value);
                const awayAmericanOdds = parseInt(document.getElementById(`away_american_odds_${i}`).value);

                if (isNaN(homeVegasOdds) || isNaN(awayVegasOdds) || homeVegasOdds <= 0 || awayVegasOdds <= 0) {
                    alert(`Please enter valid decimal odds for Game ${i}.`);
                    loadingIndicator.classList.add('hidden');
                    return;
                }

                const homeProb = (1 / homeVegasOdds) / ((1 / homeVegasOdds) + (1 / awayVegasOdds)) * 100;

                gameData.push({
                    home_vote_share: homeVoteShare, away_vote_share: 100 - homeVoteShare,
                    home_votes: homeVotes, away_votes: awayVotes,
                    home_prob: homeProb, away_prob: 100 - homeProb,
                    home_odds: homeAmericanOdds, away_odds: awayAmericanOdds
                });
                
                const lockBtn = document.getElementById(`lock-btn-${i}`);
                if (lockBtn && !document.getElementById(`locked-inputs-${i}`).classList.contains('hidden')) {
                    lockedGames[i-1] = {
                        team: document.getElementById(`team_chosen_${i}`).value,
                        bet: document.getElementById(`bet_size_${i}`).value
                    }
                }
            }

            const { bestCombination, allResults } = await optimizeWagers(numGames, gameData, lockedGames);
            
            loadingIndicator.classList.add('hidden');
            displayResults(bestCombination, allResults);
        });
        
        function displayResults(best, all) {
            if (!best) {
                bestResultDiv.innerHTML = `<p class="text-red-600 font-semibold">Could not calculate results. Please check your inputs, especially the vote totals.</p>`;
                allResultsDiv.innerHTML = '';
                resultsContainer.classList.remove('hidden');
                return;
            }
            resultsContainer.classList.remove('hidden');

            // Display best result
            let bestHtml = `<p class="text-lg"><strong>Best Total EV (Pool EV + Bet EV):</strong> <span class="font-bold text-indigo-700">${best.totalEv.toFixed(2)}</span></p>`;
            bestHtml += `<p><strong>Pool EV:</strong> ${best.poolEv.toFixed(2)}, <strong>Bet EV:</strong> ${best.betEv.toFixed(2)}</p>`;
            if (best.poolEv < 0) {
                bestHtml += `<p class="mt-2 text-red-600 font-semibold">Do not enter the pool. The Pool EV for the best combination is negative.</p>`;
            }
            bestHtml += '<h4 class="font-bold mt-4 mb-2">Recommended Selections:</h4><div class="space-y-1">';
            best.details.betDecisions.forEach((d, i) => {
                bestHtml += `<div><strong>Game ${i + 1}:</strong> Pick <span class="font-semibold">${d.pick.toUpperCase()}</span>, Bet <span class="font-semibold">${d.bet.toUpperCase()}</span></div>`;
            });
            bestHtml += '</div>';
            bestResultDiv.innerHTML = bestHtml;

            // Display all results
            allResultsDiv.innerHTML = '';
            all.forEach(res => {
                const card = document.createElement('div');
                card.className = 'p-4 rounded-md results-card shadow-sm';
                let detailsHtml = `<h4 class="font-bold text-lg">${res.picks.join(', ').toUpperCase()}</h4>`;
                detailsHtml += `<p><strong>Total EV: ${res.totalEv.toFixed(2)}</strong> (Pool: ${res.poolEv.toFixed(2)}, Bet: ${res.betEv.toFixed(2)})</p>`;
                detailsHtml += `<p class="text-sm text-gray-600">Win Prob: ${(res.details.correctProb * 100).toFixed(2)}% | 1st Place Winners: ${res.details.winners1st} | Payout: $${res.details.payout1st.toFixed(2)}</p>`;
                
                res.details.betDecisions.forEach((d, i) => {
                    detailsHtml += `<p class="text-sm text-gray-500 ml-4">Game ${i + 1}: Pick ${d.pick.toUpperCase()}, Bet ${d.bet.toUpperCase()} (EV: ${d.ev.toFixed(2)})</p>`;
                });
                card.innerHTML = detailsHtml;
                allResultsDiv.appendChild(card);
            });
        }

        // --- SAVE/LOAD FUNCTIONALITY ---
        saveBtn.addEventListener('click', () => {
            const saveName = saveNameInput.value.trim();
            if (!saveName) {
                alert("Please enter a name for your save file.");
                return;
            }
            const numGames = parseInt(numGamesSelect.value);
            if (numGames === 0 || isNaN(numGames)) {
                alert("Please select the number of games before saving.");
                return;
            }

            const dataToSave = {
                poolMode: poolModeSelect.value,
                numGames: numGames,
                games: []
            };

            for (let i = 1; i <= numGames; i++) {
                const lockBtn = document.getElementById(`lock-btn-${i}`);
                const isLocked = lockBtn && !document.getElementById(`locked-inputs-${i}`).classList.contains('hidden');
                dataToSave.games.push({
                    home_vote_share: document.getElementById(`home_vote_share_${i}`).value,
                    home_votes: document.getElementById(`home_votes_${i}`).value,
                    away_votes: document.getElementById(`away_votes_${i}`).value,
                    home_vegas_odds: document.getElementById(`home_vegas_odds_${i}`).value,
                    away_vegas_odds: document.getElementById(`away_vegas_odds_${i}`).value,
                    home_american_odds: document.getElementById(`home_american_odds_${i}`).value,
                    away_american_odds: document.getElementById(`away_american_odds_${i}`).value,
                    isLocked: isLocked,
                    team_chosen: isLocked ? document.getElementById(`team_chosen_${i}`).value : 'Home',
                    bet_size: isLocked ? document.getElementById(`bet_size_${i}`).value : 'Zero'
                });
            }
            try {
                localStorage.setItem(STORAGE_PREFIX + saveName, JSON.stringify(dataToSave));
                alert(`Inputs saved as "${saveName}"!`);
                populateSavedFilesDropdown();
            } catch (error) {
                console.error("Error saving data to localStorage: ", error);
                alert("Failed to save inputs. Your browser might not support local storage or it might be full.");
            }
        });
        
        loadBtn.addEventListener('click', () => {
            const selectedFileKey = savedFilesDropdown.value;
            if (!selectedFileKey || savedFilesDropdown.options[savedFilesDropdown.selectedIndex]?.disabled) {
                alert("Please select a valid file to load.");
                return;
            }
            try {
                const savedData = localStorage.getItem(selectedFileKey);

                if (savedData) {
                    const data = JSON.parse(savedData);
                    poolModeSelect.value = data.poolMode;
                    numGamesSelect.value = data.numGames;
                    renderGameInputs(data.numGames);

                    setTimeout(() => {
                        data.games.forEach((game, index) => {
                            const i = index + 1;
                            document.getElementById(`home_vote_share_${i}`).value = game.home_vote_share;
                            document.getElementById(`home_votes_${i}`).value = game.home_votes;
                            document.getElementById(`away_votes_${i}`).value = game.away_votes;
                            document.getElementById(`home_vegas_odds_${i}`).value = game.home_vegas_odds;
                            document.getElementById(`away_vegas_odds_${i}`).value = game.away_vegas_odds;
                            document.getElementById(`home_american_odds_${i}`).value = game.home_american_odds;
                            document.getElementById(`away_american_odds_${i}`).value = game.away_american_odds;
                            
                            const lockBtn = document.getElementById(`lock-btn-${i}`);
                            if (game.isLocked && lockBtn) {
                                const lockedInputs = document.getElementById(`locked-inputs-${i}`);
                                if (lockedInputs.classList.contains('hidden')) {
                                   lockBtn.click();
                                }
                                document.getElementById(`team_chosen_${i}`).value = game.team_chosen;
                                document.getElementById(`bet_size_${i}`).value = game.bet_size;
                            }
                        });
                         saveNameInput.value = selectedFileKey.replace(STORAGE_PREFIX, '');
                        alert(`Inputs from "${selectedFileKey.replace(STORAGE_PREFIX, '')}" loaded successfully!`);
                    }, 100);

                } else {
                    alert("Could not find the selected file.");
                    populateSavedFilesDropdown();
                }
            } catch (error) {
                console.error("Error loading data from localStorage: ", error);
                alert("Failed to load inputs.");
            }
        });

        deleteBtn.addEventListener('click', () => {
            const selectedFileKey = savedFilesDropdown.value;
            if (!selectedFileKey || savedFilesDropdown.options[savedFilesDropdown.selectedIndex]?.disabled) {
                alert("Please select a valid file to delete.");
                return;
            }

            if (confirm(`Are you sure you want to delete "${selectedFileKey.replace(STORAGE_PREFIX, '')}"? This cannot be undone.`)) {
                localStorage.removeItem(selectedFileKey);
                alert("File deleted.");
                populateSavedFilesDropdown();
            }
        });

    </script>
</body>
</html>
