<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pool Optimizer - caustic.info</title>
    <link rel="icon" href="https://raw.githubusercontent.com/potatocaustic/web-stuff/refs/heads/main/favicon.ico" type="image/x-icon" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .info-card {
            background-color: #f9f9f9;
            border: 1px solid #eee;
        }
        .results-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }
        main {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        display: none;
        }

        main.visible {
        display: block;
        }
        
        header {
            background-color: #333 !important;
            color: #fff;
            padding: 1rem;
            text-align: center;
            position: relative;
        }
        
        header h1 {
            color: white !important;
            font-size: 1.5rem;
            margin: 0;
            font-weight: bold;
        }
        
        nav ul {
          display: flex;
          justify-content: center;
          list-style: none;
          margin-top: 1rem;
          padding: 0;
          flex-wrap: wrap;
        }
        
        nav ul li {
          margin: 0.5rem 1rem;
        }
        
        nav ul li a {
          color: #fff;
          text-decoration: none;
          font-size: 1.1rem;
          transition: color 0.3s ease;
          white-space: nowrap;
        }
        
        nav ul li a:hover {
          color: #ccc;
        }
        
        footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            background-color: #333 !important;
            color: #fff;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        @media (max-width: 850px) {
            .menu-toggle {
                display: block;
                position: absolute;
                top: 1rem;
                right: 1rem;
            }

            nav ul {
                display: none;
                position: absolute;
                top: 100%;
                right: 0;
                background-color: #333;
                flex-direction: column;
                width: 200px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                z-index: 1000;
                margin-top: 0;
                text-align: left;
            }

            nav ul.show-menu {
                display: flex;
            }

            nav ul li {
                width: 100%;
                margin: 0;
            }
            
            nav ul li a {
                display: block;
                padding: 0.8rem 1rem;
                border-bottom: 1px solid #444;
                width: 100%;
            }

            nav ul li:last-child a {
                border-bottom: none;
            }
        }

        @media (min-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
        }
        #instructions-content ul {
            list-style-type: disc;
            margin-left: 20px;
        }
        #instructions-content li {
            margin-bottom: 0.5rem;
        }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
    <header>
        <h1>Pool Optimizer</h1>
          <nav>
            <button id="menu-toggle" class="menu-toggle" aria-label="Open Navigation Menu">&#9776;</button>
            <ul id="nav-menu">
                <li><a href="/index.html">Home</a></li>
                <li><a href="/PSPs/index.html">PSP Databases</a></li>
                <li><a href="/RKL/rkl-stats.html">Jammers Stats</a></li>
                <li><a href="/karma-calculator.html">Karma EV Calculator</a></li>
                <li><a href="/pool-optimizer.html">Pool Optimizer</a></li>
                <li><a href="/CFB/cfb-projections.html">CFB Projections</a></li>
            </ul>
          </nav>
    </header>
    <div id="auth-container" style="padding: 2rem; max-width: 400px; margin: 2rem auto; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
      <h2 id="auth-title">Login</h2>
      <p id="auth-error" style="color: red; margin-bottom: 1rem; min-height: 1.2em;"></p>

      <div id="login-form">
        <input type="text" id="login-username" placeholder="Username" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        <input type="password" id="login-password" placeholder="Password" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        <button id="login-button" style="background-color: #333; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; width: 100%;">Login</button>
        <p style="margin-top: 1rem;">Don't have an account? <a href="#" id="show-signup">Sign Up</a></p>
      </div>

      <div id="signup-form" style="display: none;">
        <input type="text" id="signup-username" placeholder="Choose Username" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        <input type="password" id="signup-password" placeholder="Choose Password" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        <input type="password" id="signup-confirm-password" placeholder="Confirm Password" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        <button id="signup-button" style="background-color: #5cb85c; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; width: 100%;">Sign Up</button>
        <p style="margin-top: 1rem;">Already have an account? <a href="#" id="show-login">Login</a></p>
      </div>
    </div>
    <main class="p-4 md:p-8 max-w-7xl mx-auto">
        <div id="app" class="space-y-6">
            <div class="bg-white p-4 rounded-lg shadow-md">
                <button id="instructions-toggle" class="w-full text-left font-semibold text-lg flex justify-between items-center">
                    <span>Instructions</span>
                    <svg id="instructions-arrow" class="w-5 h-5 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div id="instructions-content" class="hidden mt-4 text-gray-700 space-y-2">
                    <p>This tool helps you find the optimal combination of picks for Real pools to maximize your expected value (EV).</p>
                    <h4 class="font-semibold pt-2">Setup:</h4>
                    <ul>
                        <li><strong>Betting Type:</strong> Choose 'ML' (Moneyline) or 'Spread'. If you choose Spread, the "Real App Odds" fields will disappear and default to +100 for each side.</li>
                        <li><strong>Number of Games:</strong> Select how many games are in the pool (2, 3, or 4).</li>
                        <li><strong>Vegas Odds Format:</strong> Choose whether you want to input the Vegas odds in American or Decimal format.</li>
                    </ul>
                    <h4 class="font-semibold pt-2">Game Inputs:</h4>
                    <ul>
                        <li>For each game, input the required data for both the Away and Home teams.</li>
                        <li><strong>Vote Share (%):</strong> The percentage of users who have picked that team in the pool.</li>
                        <li><strong>Vote Total:</strong> The total number of votes on that side of the pool.</li>
                        <li><strong>Real App Odds:</strong> The American-style odds offered for the bet on Real (only for ML).</li>
                        <li><strong>Vegas Odds:</strong> The true market odds from a sportsbook. This is used to calculate the real win probability for each team.</li>
                        <li><strong>Lock Game:</strong> If a game has already started, you can enter the live Vegas odds and "lock" it. This forces the optimizer to include your chosen team and bet size in its calculations while accounting for the real-time odds of winning that game.</li>
                    </ul>
                     <h4 class="font-semibold pt-2">Results:</h4>
                    <ul>
                        <li>After clicking "Run Optimizer", the tool will display the best strategies.</li>
                        <li><strong>Highest EV Strategy:</strong> The combination of picks that provides the absolute highest total expected value.</li>
                        <li><strong>Lowest Risk Strategy (+EV):</strong> The combination with the highest chance of winning *any* payout (1st or 2nd place) that still has a positive total expected value. This may appear if it's different from the highest EV strategy.</li>
                        <li><strong>Detailed Results:</strong> A table showing the EV and other details for every possible combination of picks.</li>
                    </ul>
                    <h4 class="font-semibold pt-2">Saving & Loading:</h4>
                    <ul>
                        <li>This tool allows you to save your inputs for later, giving you the opportunity to come back and reassess your strategy if/when odds change.</li>
                        <li><strong>Storage:</strong> Pool inputs are only saved to the user's local browser storage. They will not appear on a different browser or device, or if the user erases their browsing data. </li>
                        <li><strong>WARNING:</strong> Nothing on this page is auto-saved. Users must manually save their inputs by clicking "save" if they wish to keep them.</li>
                    </ul>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Setup</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="betting-type" class="block text-sm font-medium text-gray-700 mb-1">Betting Type</label>
                                <select id="betting-type" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="ML">ML</option>
                                    <option value="Spread">Spread</option>
                                </select>
                            </div>
                            <div>
                                <label for="num-games" class="block text-sm font-medium text-gray-700 mb-1">Number of Games</label>
                                <select id="num-games" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="0" disabled selected>Select</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                </select>
                            </div>
                            <div>
                                <label for="vegas-odds-format" class="block text-sm font-medium text-gray-700 mb-1">Vegas Odds Format</label>
                                <select id="vegas-odds-format" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="American">American</option>
                                    <option value="Decimal">Decimal</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button id="submit-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 shadow-sm">Run Optimizer</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold mb-2">Save & Load Scenarios</h3>
                        <div class="space-y-3">
                            <div>
                                <label for="save-name" class="block text-sm font-medium text-gray-700 mb-1">Save Name</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="save-name" placeholder="e.g., 'Tuesday Night Slate'" class="w-full p-2 border rounded-md shadow-sm">
                                    <button id="save-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 shadow-sm whitespace-nowrap">Save</button>
                                </div>
                            </div>
                            <div>
                                <label for="saved-files-dropdown" class="block text-sm font-medium text-gray-700 mb-1">Load or Delete Saved File</label>
                                <div class="flex space-x-2">
                                    <select id="saved-files-dropdown" class="w-full p-2 border rounded-md shadow-sm"></select>
                                    <button id="load-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 shadow-sm">Load</button>
                                    <button id="delete-btn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 shadow-sm">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div id="games-container" class="space-y-6"></div>
            
            <div id="results-container" class="hidden">
                 <div id="optimal-strategies-container" class="space-y-6 mb-6">
                    </div>
                <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-900">Detailed Results</h3>
                    <div id="all-results" class="space-y-4"></div>
                </div>
            </div>
             <div id="loading-indicator" class="hidden text-center p-8">
                <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-semibold">Calculating optimal strategies...</p>
            </div>
        </div>
    </main>
    <footer>
        <p>&copy; caustic.info</p>
    </footer>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>

    <script src="auth.js"></script>
    <script>
        // --- APPLICATION LOGIC ---
        const bettingTypeSelect = document.getElementById('betting-type');
        const numGamesSelect = document.getElementById('num-games');
        const vegasOddsFormatSelect = document.getElementById('vegas-odds-format');
        const gamesContainer = document.getElementById('games-container');
        const submitBtn = document.getElementById('submit-btn');
        const saveNameInput = document.getElementById('save-name');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const savedFilesDropdown = document.getElementById('saved-files-dropdown');
        const resultsContainer = document.getElementById('results-container');
        const optimalStrategiesContainer = document.getElementById('optimal-strategies-container');
        const allResultsDiv = document.getElementById('all-results');
        const loadingIndicator = document.getElementById('loading-indicator');
        const instructionsToggle = document.getElementById('instructions-toggle');
        const instructionsContent = document.getElementById('instructions-content');
        const instructionsArrow = document.getElementById('instructions-arrow');
        const STORAGE_PREFIX = 'poolOptimizer_';

        instructionsToggle.addEventListener('click', () => {
            instructionsContent.classList.toggle('hidden');
            instructionsArrow.classList.toggle('rotate-180');
        });

        function populateSavedFilesDropdown() {
            savedFilesDropdown.innerHTML = '';
            let hasFiles = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(STORAGE_PREFIX)) {
                    hasFiles = true;
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key.replace(STORAGE_PREFIX, '');
                    savedFilesDropdown.appendChild(option);
                }
            }
            if (!hasFiles) {
                const option = document.createElement('option');
                option.textContent = 'No saved files';
                option.disabled = true;
                savedFilesDropdown.appendChild(option);
            }
        }

        document.addEventListener('DOMContentLoaded', populateSavedFilesDropdown);

        numGamesSelect.addEventListener('change', () => {
            const numGames = parseInt(numGamesSelect.value);
            if (numGames > 0) renderGameInputs(numGames);
        });
        
        bettingTypeSelect.addEventListener('change', () => {
            const numGames = parseInt(numGamesSelect.value);
             if (numGames > 0) renderGameInputs(numGames);
        });

        vegasOddsFormatSelect.addEventListener('change', () => {
            const numGames = parseInt(numGamesSelect.value);
            if (numGames === 0) return;

            const wasAmerican = vegasOddsFormatSelect.value !== 'American'; 
            
            const currentData = [];
            for (let i = 1; i <= numGames; i++) {
                const gameCard = document.getElementById(`game-${i}-card`);
                if (!gameCard) continue;
                currentData.push({
                    away_vote_share: document.getElementById(`away_vote_share_${i}`).value,
                    away_votes: document.getElementById(`away_votes_${i}`).value,
                    away_american_odds: document.getElementById(`away_american_odds_${i}`).value,
                    away_vegas_odds: document.getElementById(`away_vegas_odds_${i}`).value,
                    home_vote_share: document.getElementById(`home_vote_share_${i}`).value,
                    home_votes: document.getElementById(`home_votes_${i}`).value,
                    home_american_odds: document.getElementById(`home_american_odds_${i}`).value,
                    home_vegas_odds: document.getElementById(`home_vegas_odds_${i}`).value,
                });
            }

            renderGameInputs(numGames);

            for (let i = 1; i <= numGames; i++) {
                const data = currentData[i-1];
                if (!data) continue;
                
                document.getElementById(`away_vote_share_${i}`).value = data.away_vote_share;
                document.getElementById(`away_votes_${i}`).value = data.away_votes;
                document.getElementById(`away_american_odds_${i}`).value = data.away_american_odds;
                document.getElementById(`home_vote_share_${i}`).value = data.home_vote_share;
                document.getElementById(`home_votes_${i}`).value = data.home_votes;
                document.getElementById(`home_american_odds_${i}`).value = data.home_american_odds;

                const awayVegasInput = document.getElementById(`away_vegas_odds_${i}`);
                const homeVegasInput = document.getElementById(`home_vegas_odds_${i}`);

                if(wasAmerican) {
                    awayVegasInput.value = (americanToDecimal(data.away_vegas_odds) || 0).toFixed(2);
                    homeVegasInput.value = (americanToDecimal(data.home_vegas_odds) || 0).toFixed(2);
                } else {
                    awayVegasInput.value = Math.round(decimalToAmerican(data.away_vegas_odds)) || 0;
                    homeVegasInput.value = Math.round(decimalToAmerican(data.home_vegas_odds)) || 0;
                }
            }
        });

        function renderGameInputs(numGames) {
            gamesContainer.innerHTML = '';
            const isSpread = bettingTypeSelect.value === 'Spread';
            const isAmerican = vegasOddsFormatSelect.value === 'American';
            
            const oddsStep = isAmerican ? '1' : '0.01';
            const awayVegasValue = isAmerican ? '-110' : '1.91';
            const homeVegasValue = isAmerican ? '-110' : '1.91';

            for (let i = 1; i <= numGames; i++) {
                const gameDiv = document.createElement('div');
                gameDiv.id = `game-${i}-card`;
                gameDiv.className = 'p-6 rounded-lg shadow-md info-card';
                
                const awayBettingOddsHTML = !isSpread ? `<div><label class="block text-sm">Away Real App odds</label><input id="away_american_odds_${i}" type="number" class="w-full p-2 border rounded mt-1" value="-110"></div>` : `<input type="hidden" id="away_american_odds_${i}" value="100">`;
                const homeBettingOddsHTML = !isSpread ? `<div><label class="block text-sm">Home Real App odds</label><input id="home_american_odds_${i}" type="number" class="w-full p-2 border rounded mt-1" value="-110"></div>` : `<input type="hidden" id="home_american_odds_${i}" value="100">`;
                
                const awayVegasOddsHTML = `<div><label class="block text-sm">Away Vegas Odds</label><input id="away_vegas_odds_${i}" type="number" step="${oddsStep}" class="w-full p-2 border rounded mt-1" value="${awayVegasValue}"></div>`;
                const homeVegasOddsHTML = `<div><label class="block text-sm">Home Vegas Odds</label><input id="home_vegas_odds_${i}" type="number" step="${oddsStep}" class="w-full p-2 border rounded mt-1" value="${homeVegasValue}"></div>`;

                gameDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Game ${i}</h3>
                        <button id="lock-btn-${i}" class="bg-gray-200 text-gray-800 py-1 px-3 rounded-md hover:bg-gray-300 text-sm">Lock Game</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-center border-b pb-2">Away Team</h4>
                            <div><label class="block text-sm">Away Vote Share (%)</label><input id="away_vote_share_${i}" type="number" class="w-full p-2 border rounded mt-1" value="50"></div>
                            <div><label class="block text-sm">Away Vote Total</label><input id="away_votes_${i}" type="number" class="w-full p-2 border rounded mt-1" value="1000"></div>
                            ${awayBettingOddsHTML}
                            ${awayVegasOddsHTML}
                        </div>
                        <div class="space-y-4">
                             <h4 class="text-lg font-semibold text-center border-b pb-2">Home Team</h4>
                            <div><label class="block text-sm">Home Vote Share (%)</label><input id="home_vote_share_${i}" type="number" class="w-full p-2 border rounded mt-1" value="50"></div>
                            <div><label class="block text-sm">Home Vote Total</label><input id="home_votes_${i}" type="number" class="w-full p-2 border rounded mt-1" value="1000"></div>
                            ${homeBettingOddsHTML}
                            ${homeVegasOddsHTML}
                        </div>
                    </div>
                    <div id="locked-inputs-${i}" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 hidden">
                         <div><label class="block text-sm">Team Chosen</label><select id="team_chosen_${i}" class="w-full p-2 border rounded mt-1"><option value="Home">Home</option><option value="Away">Away</option></select></div>
                         <div><label class="block text-sm">Bet Size</label><select id="bet_size_${i}" class="w-full p-2 border rounded mt-1"><option value="Zero">Zero (10)</option><option value="Max">Max (100)</option></select></div>
                    </div>
                `;
                gamesContainer.appendChild(gameDiv);
                
                const awayVoteShareInput = document.getElementById(`away_vote_share_${i}`);
                const homeVoteShareInput = document.getElementById(`home_vote_share_${i}`);

                awayVoteShareInput.addEventListener('input', () => {
                    const awayValue = parseFloat(awayVoteShareInput.value);
                    if (!isNaN(awayValue) && awayValue >= 0 && awayValue <= 100) {
                        homeVoteShareInput.value = 100 - awayValue;
                    }
                });

                homeVoteShareInput.addEventListener('input', () => {
                    const homeValue = parseFloat(homeVoteShareInput.value);
                    if (!isNaN(homeValue) && homeValue >= 0 && homeValue <= 100) {
                        awayVoteShareInput.value = 100 - homeValue;
                    }
                });
                
                document.getElementById(`lock-btn-${i}`).addEventListener('click', (e) => {
                    const lockedInputs = document.getElementById(`locked-inputs-${i}`);
                    e.target.closest('.info-card').classList.toggle('bg-blue-100');
                    lockedInputs.classList.toggle('hidden');
                    e.target.textContent = lockedInputs.classList.contains('hidden') ? 'Lock Game' : 'Unlock Game';
                    e.target.classList.toggle('bg-blue-500');
                    e.target.classList.toggle('text-white');
                });
            }

            // Setup horizontal tabbing
            const focusableInputs = [];
            for (let i = 1; i <= numGames; i++) {
                focusableInputs.push(document.getElementById(`away_vote_share_${i}`));
                focusableInputs.push(document.getElementById(`home_vote_share_${i}`));
                focusableInputs.push(document.getElementById(`away_votes_${i}`));
                focusableInputs.push(document.getElementById(`home_votes_${i}`));
                if (!isSpread) {
                    focusableInputs.push(document.getElementById(`away_american_odds_${i}`));
                    focusableInputs.push(document.getElementById(`home_american_odds_${i}`));
                }
                focusableInputs.push(document.getElementById(`away_vegas_odds_${i}`));
                focusableInputs.push(document.getElementById(`home_vegas_odds_${i}`));
            }

            focusableInputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        const nextIndex = e.shiftKey ? 
                            (index - 1 + focusableInputs.length) % focusableInputs.length : 
                            (index + 1) % focusableInputs.length;
                        focusableInputs[nextIndex].focus();
                    }
                });
            });
        }
        
        // --- Optimizer Logic & Helpers ---
        function americanToDecimal(american) {
            const odds = parseFloat(american);
            if (isNaN(odds)) return 0;
            if (odds > 0) return (odds / 100) + 1;
            return (100 / Math.abs(odds)) + 1;
        }

        function decimalToAmerican(decimal) {
            const odds = parseFloat(decimal);
            if (isNaN(odds) || odds === 0) return 0;
            if (odds >= 2.0) return (odds - 1) * 100;
            return -100 / (odds - 1);
        }

        const participationRate = 50.0;
        const zeroBetsAllowed = 'YES';

        function calculateTki(participationRate, minVoteTotal) {
            const participants = Math.floor(participationRate * minVoteTotal / 100);
            return [participants * 100, participants];
        }

        function calculatePayouts(tki, winners1st, winners2nd = 0, num_games) {
            // Handle edge case with no winners
            if (winners1st === 0) return [0, 0];
            
            // This part handles 2 and 3 game pools, which have no 2nd place payout.
            // The logic remains the same for these.
            if (winners2nd === 0 || num_games !== 4) {
                const maxPayout = num_games === 3 ? 600 : (num_games === 2 ? 400 : 800);
                return [Math.min(maxPayout, Math.floor(tki / winners1st)), 0];
            }

            // --- NEW SIMPLIFIED LOGIC FOR 4-GAME POOLS ---
            // Based on the principle that Payout1st = 2 * Payout2nd
            // and (Payout1st * winners1st) + (Payout2nd * winners2nd) = tki
            // We can solve for Payout2nd: tki / (2 * winners1st + winners2nd)

            const weightedWinnerTotal = (2 * winners1st) + winners2nd;
            
            // Avoid division by zero if there are no expected winners.
            if (weightedWinnerTotal === 0) {
                return [0, 0];
            }

            const payout2nd_ideal = tki / weightedWinnerTotal;
            const payout1st_ideal = 2 * payout2nd_ideal;

            // Apply the payout caps as requested.
            const finalPayout1st = Math.min(800, payout1st_ideal);
            const finalPayout2nd = Math.min(600, payout2nd_ideal);
            
            // Return the final, whole-number payouts.
            return [Math.floor(finalPayout1st), Math.floor(finalPayout2nd)];
        }

        function expectedValue(probability, odds, betType) {
            const wager = betType === 'Max' ? 100 : 10;
            if (betType === 'Zero') return probability * ((odds > 0 ? (odds/100) * 10 : (-100/odds) * 10));
            const betWin = odds > 0 ? (odds / 100) * wager : (-100 / odds) * wager;
            return probability * betWin - (1 - probability) * wager;
        }

        function getCombinations(n, locked) {
            const teams = ['home', 'away'];
            let allCombos = [];
            function generate(index, currentCombo) {
                if (index === n) {
                    allCombos.push(currentCombo);
                    return;
                }
                if (locked[index]) {
                     generate(index + 1, [...currentCombo, locked[index].team.toLowerCase()]);
                } else {
                    teams.forEach(team => generate(index + 1, [...currentCombo, team]));
                }
            }
            generate(0, []);
            return allCombos;
        }

        async function optimizeWagers(numGames, gameData, lockedGames) {
            return new Promise(resolve => {
                setTimeout(() => { 
                    if (gameData.some(g => isNaN(g.home_votes) || isNaN(g.away_votes))) {
                         resolve({ allResults: [] }); 
                         return;
                    }
                    const minVoteTotal = Math.min(...gameData.map(g => g.home_votes + g.away_votes));
                    if (minVoteTotal === 0 || isNaN(minVoteTotal)) {
                        resolve({ allResults: [] });
                        return;
                    }
                    const [tki, participants] = calculateTki(participationRate, minVoteTotal);
                    let allResults = [];
                    const picksCombinations = getCombinations(numGames, lockedGames);

                    for (const picks of picksCombinations) {
                        let correctProb = 1.0, voteShareFactor = 1.0;
                        picks.forEach((pick, i) => {
                            correctProb *= gameData[i][`${pick}_prob`] / 100.0;
                            voteShareFactor *= gameData[i][`${pick}_vote_share`] / 100.0;
                        });

                        const expectedWinners1st = Math.max(1, Math.round(participants * voteShareFactor));
                        let expectedWinners2nd = 0, secondPlaceProb = 0;
                        
                        if (numGames === 4) {
                            for (let i = 0; i < numGames; i++) {
                                const oppositePick = picks[i] === 'home' ? 'away' : 'home';
                                secondPlaceProb += (correctProb / (gameData[i][`${picks[i]}_prob`] / 100.0)) * (gameData[i][`${oppositePick}_prob`] / 100.0);
                            }
                            expectedWinners2nd = Math.max(1, Math.floor(participants * secondPlaceProb));
                        }
                        
                        const [payout1st, payout2nd] = calculatePayouts(tki, expectedWinners1st, expectedWinners2nd, numGames);
                        let totalBetEv = 0, betDecisions = [];
                        
                        for (let i = 0; i < picks.length; i++) {
                            const { [`${picks[i]}_prob`]: probability, [`${picks[i]}_odds`]: odds } = gameData[i];
                            let betType, betEv;
                            if (lockedGames[i]) {
                                betType = lockedGames[i].bet;
                                betEv = expectedValue(probability / 100, odds, betType);
                            } else {
                                const evMax = expectedValue(probability / 100, odds, 'Max');
                                const evZero = expectedValue(probability / 100, odds, 'Zero');
                                betType = (zeroBetsAllowed === 'NO' || evMax > evZero) ? 'Max' : 'Zero';
                                betEv = (betType === 'Max') ? evMax : evZero;
                            }
                            betDecisions.push({ pick: picks[i], bet: betType, ev: betEv });
                            totalBetEv += betEv;
                        }
                        
                        const poolEv = (numGames === 4) 
                            ? (correctProb * payout1st) + (secondPlaceProb * payout2nd) - 100 
                            : (correctProb * payout1st) - 100;
                        
                        allResults.push({
                            picks, totalEv: totalBetEv + poolEv, betEv: totalBetEv, poolEv, 
                            details: { correctProb, secondPlaceProb, payout1st, payout2nd, betDecisions }
                        });
                    }
                    allResults.sort((a, b) => b.totalEv - a.totalEv);
                    resolve({ allResults });
                }, 50);
            });
        }
        
        submitBtn.addEventListener('click', async () => {
            const numGames = parseInt(numGamesSelect.value);
            if(numGames === 0 || isNaN(numGames)) return alert("Please select the number of games.");

            resultsContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            const gameData = [], lockedGames = {};
            const isAmerican = vegasOddsFormatSelect.value === 'American';

            for (let i = 1; i <= numGames; i++) {
                const homeVegasInput = parseFloat(document.getElementById(`home_vegas_odds_${i}`).value);
                const awayVegasInput = parseFloat(document.getElementById(`away_vegas_odds_${i}`).value);
                const homeVegasOdds = isAmerican ? americanToDecimal(homeVegasInput) : homeVegasInput;
                const awayVegasOdds = isAmerican ? americanToDecimal(awayVegasInput) : awayVegasInput;
                
                if (isNaN(homeVegasOdds) || isNaN(awayVegasOdds) || homeVegasOdds <= 0 || awayVegasOdds <= 0) {
                    loadingIndicator.classList.add('hidden');
                    return alert(`Please enter valid Vegas odds for Game ${i}.`);
                }

                const homeProb = (1 / homeVegasOdds) / ((1 / homeVegasOdds) + (1 / awayVegasOdds)) * 100;

                gameData.push({
                    home_vote_share: parseFloat(document.getElementById(`home_vote_share_${i}`).value),
                    away_vote_share: parseFloat(document.getElementById(`away_vote_share_${i}`).value),
                    home_votes: parseInt(document.getElementById(`home_votes_${i}`).value),
                    away_votes: parseInt(document.getElementById(`away_votes_${i}`).value),
                    home_prob: homeProb, away_prob: 100 - homeProb,
                    home_odds: parseInt(document.getElementById(`home_american_odds_${i}`).value),
                    away_odds: parseInt(document.getElementById(`away_american_odds_${i}`).value)
                });
                
                const lockBtn = document.getElementById(`lock-btn-${i}`);
                if (lockBtn && !document.getElementById(`locked-inputs-${i}`).classList.contains('hidden')) {
                    lockedGames[i-1] = {
                        team: document.getElementById(`team_chosen_${i}`).value,
                        bet: document.getElementById(`bet_size_${i}`).value
                    };
                }
            }

            const { allResults } = await optimizeWagers(numGames, gameData, lockedGames);
            loadingIndicator.classList.add('hidden');
            displayResults(allResults);
        });
        
        function createStrategyCard(combo, title, numGames) {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-lg shadow-md';
            if (!combo) {
                card.innerHTML = `<h2 class="text-xl font-bold mb-2 text-gray-900">${title}</h2><p>No suitable combination found.</p>`;
                return card;
            }
            
            let payoutHtml;
            const firstProb = (combo.details.correctProb * 100);
            if (numGames === 4) {
                const secondProb = (combo.details.secondPlaceProb * 100);
                const totalProb = firstProb + secondProb;
                payoutHtml = `<strong>Payout Probability:</strong> <span class="font-semibold">${totalProb.toFixed(2)}% (${firstProb.toFixed(2)}% 1st + ${secondProb.toFixed(2)}% 2nd)</span>`;
            } else {
                payoutHtml = `<strong>Payout Probability:</strong> <span class="font-semibold">${firstProb.toFixed(2)}% (1st Place)</span>`;
            }

            let html = `<h2 class="text-xl font-bold mb-4 text-gray-900">${title}</h2>`;
            html += `<p class="text-lg"><strong>Total EV (Pool EV + Bet EV):</strong> <span class="font-bold text-indigo-700">${combo.totalEv.toFixed(2)}</span></p>`;
            html += `<p><strong>Pool EV:</strong> ${combo.poolEv.toFixed(2)}, <strong>Bet EV:</strong> ${combo.betEv.toFixed(2)}</p>`;
            html += `<p>${payoutHtml}</p>`;

            if (combo.poolEv < 0) {
                html += `<p class="mt-2 text-red-600 font-semibold">Warning: The Pool EV for this combination is negative.</p>`;
            }
            html += '<h4 class="font-bold mt-4 mb-2">Recommended Selections:</h4><div class="space-y-1">';
            combo.details.betDecisions.forEach((d, i) => {
                html += `<div><strong>Game ${i + 1}:</strong> Pick <span class="font-semibold">${d.pick.toUpperCase()}</span>, Bet <span class="font-semibold">${d.bet.toUpperCase()}</span></div>`;
            });
            html += '</div>';
            card.innerHTML = html;
            return card;
        }

        function displayResults(all) {
            optimalStrategiesContainer.innerHTML = '';
            allResultsDiv.innerHTML = '';

            if (!all || all.length === 0) {
                optimalStrategiesContainer.innerHTML = `<p class="text-red-600 font-semibold">Could not calculate results. Please check your inputs, especially the vote totals.</p>`;
                resultsContainer.classList.remove('hidden');
                return;
            }

            const numGames = parseInt(numGamesSelect.value);
            const highestEvCombo = all[0];
            const positiveEvCombos = all.filter(res => res.totalEv > 0);
            let lowestRiskCombo = null;

            if (positiveEvCombos.length > 0) {
                lowestRiskCombo = positiveEvCombos.reduce((prev, current) => {
                    const prevProb = prev.details.correctProb + (prev.details.secondPlaceProb || 0);
                    const currentProb = current.details.correctProb + (current.details.secondPlaceProb || 0);
                    return currentProb > prevProb ? current : prev;
                });
            }

            const areSame = lowestRiskCombo && highestEvCombo.picks.join(',') === lowestRiskCombo.picks.join(',');
            
            if (areSame) {
                optimalStrategiesContainer.appendChild(createStrategyCard(highestEvCombo, 'Highest EV & Lowest Risk Strategy', numGames));
            } else {
                optimalStrategiesContainer.appendChild(createStrategyCard(highestEvCombo, 'Highest EV Strategy', numGames));
                if (lowestRiskCombo) {
                    optimalStrategiesContainer.appendChild(createStrategyCard(lowestRiskCombo, 'Lowest Risk Strategy (+EV)', numGames));
                }
            }

            all.forEach(res => {
                const card = document.createElement('div');
                card.className = 'p-4 rounded-md results-card shadow-sm';
                let detailsText = `Win Prob: ${(res.details.correctProb * 100).toFixed(2)}%`;
                if (numGames === 4) {
                    detailsText += ` | 2nd Place Prob: ${(res.details.secondPlaceProb * 100).toFixed(2)}%`;
                }
                detailsText += ` | 1st place payout: ${Math.round(res.details.payout1st)}`;

                let detailsHtml = `<h4 class="font-bold text-lg">${res.picks.join(', ').toUpperCase()}</h4>`;
                detailsHtml += `<p><strong>Total EV: ${res.totalEv.toFixed(2)}</strong> (Pool: ${res.poolEv.toFixed(2)}, Bet: ${res.betEv.toFixed(2)})</p>`;
                detailsHtml += `<p class="text-sm text-gray-600">${detailsText}</p>`;
                res.details.betDecisions.forEach((d, i) => {
                    detailsHtml += `<p class="text-sm text-gray-500 ml-4">Game ${i + 1}: Pick ${d.pick.toUpperCase()}, Bet ${d.bet.toUpperCase()} (EV: ${d.ev.toFixed(2)})</p>`;
                });
                card.innerHTML = detailsHtml;
                allResultsDiv.appendChild(card);
            });
            
            resultsContainer.classList.remove('hidden');
        }

        // --- SAVE/LOAD FUNCTIONALITY ---
        saveBtn.addEventListener('click', () => {
            const saveName = saveNameInput.value.trim();
            if (!saveName) return alert("Please enter a name for your save file.");
            
            const numGames = parseInt(numGamesSelect.value);
            if (numGames === 0 || isNaN(numGames)) return alert("Please select the number of games before saving.");

            const dataToSave = {
                bettingType: bettingTypeSelect.value,
                vegasOddsFormat: vegasOddsFormatSelect.value,
                numGames: numGames,
                games: []
            };

            for (let i = 1; i <= numGames; i++) {
                const lockBtn = document.getElementById(`lock-btn-${i}`);
                const isLocked = lockBtn && !document.getElementById(`locked-inputs-${i}`).classList.contains('hidden');
                dataToSave.games.push({
                    home_vote_share: document.getElementById(`home_vote_share_${i}`).value,
                    away_vote_share: document.getElementById(`away_vote_share_${i}`).value,
                    home_votes: document.getElementById(`home_votes_${i}`).value,
                    away_votes: document.getElementById(`away_votes_${i}`).value,
                    home_vegas_odds: document.getElementById(`home_vegas_odds_${i}`).value,
                    away_vegas_odds: document.getElementById(`away_vegas_odds_${i}`).value,
                    home_american_odds: document.getElementById(`home_american_odds_${i}`).value,
                    away_american_odds: document.getElementById(`away_american_odds_${i}`).value,
                    isLocked: isLocked,
                    team_chosen: isLocked ? document.getElementById(`team_chosen_${i}`).value : 'Home',
                    bet_size: isLocked ? document.getElementById(`bet_size_${i}`).value : 'Zero'
                });
            }
            try {
                localStorage.setItem(STORAGE_PREFIX + saveName, JSON.stringify(dataToSave));
                alert(`Inputs saved as "${saveName}"!`);
                populateSavedFilesDropdown();
            } catch (error) {
                console.error("Error saving data:", error);
                alert("Failed to save inputs.");
            }
        });
        
        loadBtn.addEventListener('click', () => {
            const selectedFileKey = savedFilesDropdown.value;
            if (!selectedFileKey || savedFilesDropdown.options[savedFilesDropdown.selectedIndex]?.disabled) {
                return alert("Please select a valid file to load.");
            }
            try {
                const savedData = JSON.parse(localStorage.getItem(selectedFileKey));
                if (savedData) {
                    bettingTypeSelect.value = savedData.bettingType;
                    vegasOddsFormatSelect.value = savedData.vegasOddsFormat || 'American';
                    numGamesSelect.value = savedData.numGames;
                    renderGameInputs(savedData.numGames);

                    setTimeout(() => {
                        savedData.games.forEach((game, index) => {
                            const i = index + 1;
                            document.getElementById(`home_vote_share_${i}`).value = game.home_vote_share;
                            document.getElementById(`away_vote_share_${i}`).value = game.away_vote_share;
                            document.getElementById(`home_votes_${i}`).value = game.home_votes;
                            document.getElementById(`away_votes_${i}`).value = game.away_votes;
                            document.getElementById(`home_vegas_odds_${i}`).value = game.home_vegas_odds;
                            document.getElementById(`away_vegas_odds_${i}`).value = game.away_vegas_odds;
                            
                            const homeOddsInput = document.getElementById(`home_american_odds_${i}`);
                            if(homeOddsInput) homeOddsInput.value = game.home_american_odds;

                            const awayOddsInput = document.getElementById(`away_american_odds_${i}`);
                            if(awayOddsInput) awayOddsInput.value = game.away_american_odds;
                            
                            const lockBtn = document.getElementById(`lock-btn-${i}`);
                            if (game.isLocked && lockBtn) {
                                lockBtn.click();
                                document.getElementById(`team_chosen_${i}`).value = game.team_chosen;
                                document.getElementById(`bet_size_${i}`).value = game.bet_size;
                            }
                        });
                        saveNameInput.value = selectedFileKey.replace(STORAGE_PREFIX, '');
                    }, 100);
                }
            } catch (error) {
                console.error("Error loading data:", error);
                alert("Failed to load inputs.");
            }
        });

        deleteBtn.addEventListener('click', () => {
            const selectedFileKey = savedFilesDropdown.value;
            if (!selectedFileKey || savedFilesDropdown.options[savedFilesDropdown.selectedIndex]?.disabled) {
                return alert("Please select a valid file to delete.");
            }
            if (confirm(`Are you sure you want to delete "${selectedFileKey.replace(STORAGE_PREFIX, '')}"?`)) {
                localStorage.removeItem(selectedFileKey);
                alert("File deleted.");
                populateSavedFilesDropdown();
            }
        });
    </script>
     <script>
        document.addEventListener('DOMContentLoaded', () => {
            const menuToggle = document.getElementById('menu-toggle');
            const navMenu = document.getElementById('nav-menu');

            if (menuToggle && navMenu) {
                menuToggle.addEventListener('click', () => {
                    navMenu.classList.toggle('show-menu');
                });
            }
        });
    </script>
</body>
</html>
